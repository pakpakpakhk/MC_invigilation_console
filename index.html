<!DOCTYPE html><html lang="en" data-theme="midnight"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Form 6 Invigilation Countdown · Methodist College</title>
  <style>
    :root {
      color-scheme: dark;
      --bg-main: #0b111a;
      --bg-panel: rgba(18, 24, 33, 0.92);
      --text-primary: #f0f6fc;
      --text-secondary: #8b949e;
      --accent: #58a6ff;
      --accent-alt: #7d9bff;
      --warning: #f7d774;
      --danger: #ff7b72;
      --success: #3fb950;
      --panel-border: rgba(255, 255, 255, 0.05);
      --header-gradient: linear-gradient(135deg, rgba(88, 101, 242, 0.58), rgba(11, 17, 26, 0.92));
      --panel-blur: rgba(11, 16, 24, 0.8);
      --announcement-bg: rgba(88, 101, 242, 0.16);
      --announcement-border: rgba(88, 101, 242, 0.32);
      --schedule-bg: rgba(20, 28, 42, 0.65);
      --schedule-item-bg: rgba(88, 101, 242, 0.12);
      --schedule-item-hover: rgba(88, 101, 242, 0.22);
      --schedule-item-active: rgba(88, 101, 242, 0.32);
      --button-primary: linear-gradient(135deg, #58a6ff, #7d9bff);
      --button-danger: linear-gradient(135deg, #ff7b72, #ff9d8f);
      --button-ghost: rgba(240, 246, 252, 0.08);
      --shadow: 0 18px 45px rgba(2, 5, 12, 0.55);
      --progress-track: rgba(88, 101, 242, 0.18);
      --modal-overlay: rgba(7, 12, 23, 0.78);
      --file-loader-bg: rgba(255, 255, 255, 0.05);
      --file-loader-border: rgba(255, 255, 255, 0.15);
      --select-focus-border: rgba(88, 101, 242, 0.6);
      --select-focus-bg: rgba(88, 101, 242, 0.14);
      --secondary-btn-bg: rgba(240, 246, 252, 0.92);
      --secondary-btn-color: #0d1117;
      --primary-btn-text: #0d1117;
      --file-upload-button-text: #0d1117;
      --timer-warning-color: #ffb347;
      --timer-danger-color: #ff6b6b;
      --outer-padding: clamp(0.65rem, 0.8vw, 1.6rem);
      font-size: clamp(16px, 1.15vw, 19px);
    }

    /* Theme variants (unchanged) omitted for brevity */

    /* ... OMITTED THEME DEFINITIONS (dawn, emerald, graphite, sunset, aurora) ... */

    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; min-height: 100%; }

    body {
      margin: 0;
      background: radial-gradient(circle at 15% 20%, var(--bg-main), #000 60%);
      color: var(--text-primary);
      font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
      padding: var(--outer-padding);
      display: flex;
      justify-content: center;
      align-items: stretch;
      overflow: hidden;
      transition: background 0.6s ease, color 0.4s ease;
    }

    .page-shell {
      width: min(100%, 3440px);
      height: calc(100vh - (2 * var(--outer-padding)));
      display: flex;
      flex-direction: column;
      gap: clamp(1rem, 1.4vw, 1.8rem);
      margin: 0 auto;
      position: relative;
    }

    header {
      position: sticky;
      top: var(--outer-padding);
      z-index: 20;
      background: var(--header-gradient);
      border-radius: 22px;
      padding: clamp(1.15rem, 1.6vw, 2.1rem);
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: clamp(1rem, 1.4vw, 1.6rem);
      box-shadow: var(--shadow);
      overflow: hidden;
      border: 1px solid var(--panel-border);
      transition: background 0.6s ease, border 0.4s ease;
    }

    header::after {
      content: "";
      position: absolute;
      inset: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="420" height="420" viewBox="0 0 420 420"><g fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="2"><path d="M0,70 Q210,0 420,70"/><path d="M0,140 Q210,70 420,140"/><path d="M0,210 Q210,140 420,210"/><path d="M0,280 Q210,210 420,280"/><path d="M0,350 Q210,280 420,350"/></g></svg>') center/cover;
      opacity: 0.18;
      pointer-events: none;
    }

    .branding { grid-column: span 12; display: flex; flex-direction: column; gap: 0.15rem; z-index: 1; }
    .school-name { font-size: clamp(1.2rem, 2.1vw, 2.4rem); font-weight: 700; letter-spacing: 0.16em; text-transform: uppercase; }

    .subject-block { grid-column: span 4; display: flex; flex-direction: column; gap: 0.65rem; z-index: 1; }
    .subject-label { text-transform: uppercase; letter-spacing: 0.35em; font-size: 0.74rem; color: var(--text-secondary); }
    #subjectDisplay { font-size: clamp(1.9rem, 2.8vw, 3.1rem); line-height: 1.2; font-weight: 700; text-transform: uppercase; }

    .timer-block { grid-column: span 4; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.55rem; z-index: 1; }
    #countdown { font-size: clamp(2.8rem, 4.1vw, 4.6rem); font-weight: 800; letter-spacing: 0.12em; font-variant-numeric: tabular-nums; white-space: nowrap; text-shadow: 0 18px 40px rgba(0, 0, 0, 0.4); transition: color 0.4s ease; }

    .timer-warning { color: var(--timer-warning-color) !important; animation: timerBlinkSoft 1.2s ease-in-out infinite; }
    .timer-danger { color: var(--timer-danger-color) !important; animation: timerBlinkFast 0.7s ease-in-out infinite; }

    @keyframes timerBlinkSoft { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(0.985); } }
    @keyframes timerBlinkFast { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.55; transform: scale(0.975); } }

    #statusLabel { font-size: 0.95rem; letter-spacing: 0.28em; text-transform: uppercase; color: var(--text-secondary); }

    .meta-block { grid-column: span 4; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.1rem; z-index: 1; }
    .meta-item { display: flex; flex-direction: column; gap: 0.35rem; min-width: 0; }
    .meta-label { font-size: 0.74rem; letter-spacing: 0.22em; text-transform: uppercase; color: var(--text-secondary); }
    .meta-value { font-size: 1.12rem; font-weight: 600; color: var(--text-primary); }

    .content-scroll {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      grid-template-rows: 1fr;
      overflow: hidden;
      min-height: 0;
    }

    .content-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.7fr) minmax(0, 0.9fr);
      gap: clamp(1rem, 1.6vw, 2rem);
      align-items: stretch;
      min-height: 0;
    }

    main {
      background: var(--bg-panel);
      border-radius: 24px;
      padding: clamp(1.4rem, 2vw, 2.1rem);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: clamp(1.2rem, 1.8vw, 2rem);
      border: 1px solid var(--panel-border);
      backdrop-filter: blur(8px);
      min-height: 0;
    }

    #alertBanner {
      border-radius: 16px;
      padding: 1.05rem 1.3rem;
      font-size: 1.05rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.3em;
      text-align: center;
      display: none;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    #alertBanner.show { display: block; }
    #alertBanner.warning { background: rgba(247, 215, 116, 0.18); color: var(--warning); }
    #alertBanner.danger { background: rgba(255, 123, 114, 0.2); color: var(--danger); animation: alertPulse 1.3s ease-in-out infinite; }
    #alertBanner.final { background: rgba(63, 185, 80, 0.2); color: var(--success); animation: none; }

    @keyframes alertPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.035); } }

    .panels-grid {
      display: grid;
      grid-template-columns: 1.4fr 1.15fr 0.75fr;
      gap: clamp(1rem, 1.5vw, 1.8rem);
      align-items: stretch;
      min-height: 0;
    }

    .panel {
      background: var(--panel-blur);
      border-radius: 20px;
      padding: clamp(1rem, 1.6vw, 1.7rem);
      display: flex;
      flex-direction: column;
      gap: 0.95rem;
      border: 1px solid var(--panel-border);
      min-height: 0;
    }

    .panel h2 { margin: 0; font-size: 1rem; letter-spacing: 0.18em; text-transform: uppercase; color: var(--text-secondary); }

    .progress-wrapper { display: flex; flex-direction: column; gap: 0.65rem; }
    .progress-bar { height: 18px; border-radius: 999px; background: var(--progress-track); overflow: hidden; }
    .progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--accent-alt)); transition: width 0.6s ease; }

    .progress-meta { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 0.8rem; }

    .announcement-board { display: flex; flex-direction: column; gap: 0.9rem; overflow: hidden; }
    .announcement-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 0.8rem; padding-right: 0.5rem; }

    .announcement-card { background: var(--announcement-bg); border-radius: 18px; padding: 1rem 1.2rem; border: 1px solid var(--announcement-border); display: grid; gap: 0.65rem; }
    .announcement-card header { display: flex; justify-content: space-between; align-items: baseline; }
    .announcement-card h3 { margin: 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.12em; }
    .announcement-card time { font-size: 0.78rem; color: var(--text-secondary); letter-spacing: 0.12em; }
    .announcement-card p { margin: 0; font-size: 1.05rem; line-height: 1.5; }

    .schedule-panel { display: flex; flex-direction: column; gap: 0.8rem; }
    .schedule-list { display: flex; flex-direction: column; gap: 0.75rem; max-height: 370px; overflow-y: auto; padding-right: 0.4rem; }
    .schedule-group { background: var(--schedule-bg); border-radius: 18px; border: 1px solid var(--panel-border); padding: 0.9rem 1.1rem; display: grid; gap: 0.75rem; }
    .schedule-date-heading { margin: 0; font-size: 0.85rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--text-secondary); }

    .schedule-item {
      padding: 0.75rem 1rem;
      border-radius: 15px;
      background: var(--schedule-item-bg);
      border: 1px solid transparent;
      display: grid;
      gap: 0.3rem;
      cursor: pointer;
      transition: background 0.25s ease, transform 0.2s ease, border 0.3s ease, box-shadow 0.3s ease;
    }
    .schedule-item:hover { background: var(--schedule-item-hover); transform: translateY(-1px); }
    .schedule-item.active { border-color: var(--accent); background: var(--schedule-item-active); box-shadow: 0 12px 24px rgba(88, 101, 242, 0.25); }
    .schedule-item .time { font-size: 0.82rem; letter-spacing: 0.14em; text-transform: uppercase; color: var(--text-secondary); }
    .schedule-item .subject { font-size: 1rem; font-weight: 600; }
    .schedule-item .venue { font-size: 0.85rem; color: var(--text-secondary); }

    aside.control-dock {
      background: var(--panel-blur);
      border-radius: 22px;
      padding: clamp(1.4rem, 2vw, 2rem);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
      border: 1px solid var(--panel-border);
      position: sticky;
      top: calc(var(--outer-padding) + 0.4rem);
      max-height: calc(100vh - (2 * var(--outer-padding)) - 0.8rem);
      overflow-y: auto;
      overscroll-behavior: contain;
      min-height: 0;
    }

    .control-dock h2 { margin: 0; font-size: 0.95rem; letter-spacing: 0.22em; text-transform: uppercase; color: var(--text-secondary); }

    form { display: grid; gap: 0.8rem; }
    label {
      display: grid;
      gap: 0.4rem;
      font-size: 0.78rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--text-secondary);
    }

    select,
    input[type="text"],
    input[type="number"],
    input[type="time"],
    input[type="date"],
    textarea {
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 16px;
      padding: 0.7rem 0.95rem;
      color: var(--text-primary);
      font-size: 1rem;
      font-family: inherit;
      transition: border 0.3s ease, background 0.3s ease, color 0.3s ease;
    }

    select:focus,
    input:focus,
    textarea:focus {
      outline: none;
      border-color: var(--select-focus-border);
      background: var(--select-focus-bg);
    }

    textarea { resize: vertical; min-height: 160px; }

    .duration-row,
    .time-range-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.6rem;
    }

    .time-range-row { grid-template-columns: repeat(2, minmax(0, 1fr)); }

    .button-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.75rem;
    }

    button {
      border: none;
      border-radius: 16px;
      padding: 0.8rem 1rem;
      font-size: 0.88rem;
      font-weight: 600;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
    }

    button:active { transform: scale(0.97); }
    .btn-primary { background: var(--button-primary); box-shadow: 0 12px 24px rgba(88, 166, 255, 0.28); color: var(--primary-btn-text); }
    .btn-secondary { background: var(--secondary-btn-bg); color: var(--secondary-btn-color); }
    .btn-danger { background: var(--button-danger); color: var(--primary-btn-text); }
    .btn-ghost { background: var(--button-ghost); color: var(--text-primary); }
    button:disabled { opacity: 0.45; cursor: not-allowed; transform: none; box-shadow: none; }

    .file-loader {
      display: grid;
      gap: 0.6rem;
      padding: 0.9rem 1rem;
      border-radius: 16px;
      background: var(--file-loader-bg);
      border: 1px dashed var(--file-loader-border);
    }

    .file-loader input[type="file"] {
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 0.95rem;
    }

    .file-loader input[type="file"]::-webkit-file-upload-button {
      border: none;
      border-radius: 14px;
      padding: 0.6rem 1rem;
      margin-right: 0.6rem;
      background: var(--button-primary);
      color: var(--file-upload-button-text);
      font-weight: 600;
      letter-spacing: 0.1em;
      cursor: pointer;
      box-shadow: 0 12px 24px rgba(88, 166, 255, 0.28);
    }

    .modal {
      position: fixed;
      inset: 0;
      background: var(--modal-overlay);
      display: flex;
      align-items: center;
      justify-content: center;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      z-index: 999;
      padding: 1rem;
    }

    .modal.show { visibility: visible; opacity: 1; }

    .modal-card {
      width: min(100%, 540px);
      background: var(--bg-panel);
      border-radius: 22px;
      padding: clamp(1.4rem, 2vw, 2rem);
      border: 1px solid var(--panel-border);
      box-shadow: 0 18px 48px rgba(0, 0, 0, 0.55);
      display: grid;
      gap: 1.1rem;
      position: relative;
    }

    .modal-card h3 {
      margin: 0;
      font-size: 0.95rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--text-secondary);
    }

    .modal-close {
      position: absolute;
      top: 0.85rem;
      right: 0.85rem;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      font-size: 1.15rem;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.12);
      color: var(--text-primary);
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .modal-close:hover { transform: rotate(90deg); }

    @media (max-width: 1440px) {
      .panels-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .announcement-board { grid-column: span 1; }
      .schedule-panel { grid-column: span 2; }
    }

    @media (max-width: 1280px) {
      .page-shell { height: auto; }
      body { overflow: auto; }
      header { grid-template-columns: repeat(6, 1fr); position: static; }
      .branding, .subject-block, .timer-block, .meta-block { grid-column: span 6; }
      .content-scroll { overflow: auto; }
      .content-grid { grid-template-columns: 1fr; }
      .panels-grid { grid-template-columns: 1fr; }
      aside.control-dock { position: static; max-height: none; }
    }

    @media (max-width: 768px) {
      header { grid-template-columns: repeat(4, 1fr); gap: clamp(0.8rem, 2.4vw, 1.1rem); }
      .branding, .subject-block, .timer-block, .meta-block { grid-column: span 4; }
      .duration-row, .time-range-row { grid-template-columns: repeat(3, minmax(0, 1fr)); }
      .time-range-row { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      #statusLabel { letter-spacing: 0.2em; }
    }
  </style>
<script src="https://puc.poecdn.net/authenticated_preview_page/syncedState.bd4eeeb8e8e02052ee92.js"></script>
<style id="invigilation-overrides">
  aside.control-dock { max-height: 100vh; overflow: auto; word-wrap: break-word; overflow-wrap: anywhere; }
  aside.control-dock .panel { padding: 0.65rem 0.7rem; border-radius: 12px; }
  aside.control-dock .panel h2 { font-size: 16px; line-height: 1.2; margin: 0 0 0.4rem 0; }
  aside.control-dock .panel h3, .schedule-date-heading { font-size: 14px !important; line-height: 1.25; margin: 0.4rem 0 0.4rem; }
  aside.control-dock .panel label { font-size: 12px; line-height: 1.25; display: grid; gap: 0.3rem; }
  aside.control-dock .panel small { font-size: 11px; }
  aside.control-dock input, aside.control-dock select, aside.control-dock textarea {
    font-size: 12px !important; padding: 0.35rem 0.45rem !important; min-height: 30px; line-height: 1.25;
  }
  aside.control-dock textarea { min-height: 56px; }
  aside.control-dock .btn-primary, aside.control-dock .btn-secondary, aside.control-dock .btn-ghost, aside.control-dock button {
    font-size: 12px !important; padding: 0.4rem 0.6rem !important; line-height: 1.2;
  }
  .button-row { display: grid; gap: 0.4rem; }
  #issuesContainer > div { font-size: 12px; }
  #issuesContainer > div > div[style*="grid-template-columns: repeat(3"] { grid-template-columns: repeat(3, minmax(0, 1fr)) !important; }
  #issuesContainer > div > div[style*="grid-template-columns: repeat(2"] { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
  #issuesContainer { gap: 0.5rem; }
  aside.control-dock section.panel { margin-bottom: 0.6rem; }
  aside.control-dock .panel:has(#issuesContainer) { max-height: 78vh; overflow: auto; }
</style>


<style id="invigilation-size-up">
  /* Widen the right dock substantially and allow tall content */
  aside.control-dock {
    width: clamp(460px, 46vw, 780px) !important;
    max-height: 100vh;
    overflow: auto;
  }
  /* Make the Invigilation Records panel occupy most of the dock's height */
  aside.control-dock .panel:has(#issuesContainer) {
    max-height: none !important;
  }
  /* Give the issues list its own generous scroll area */
  #issuesContainer {
    max-height: 68vh;
    overflow: auto;
  }
  /* Slightly increase base font-size for legibility */
  aside.control-dock .panel,
  aside.control-dock label,
  aside.control-dock input,
  aside.control-dock select,
  aside.control-dock textarea,
  aside.control-dock button {
    font-size: 13px !important;
  }
  aside.control-dock .panel h2 { font-size: 18px !important; }
  aside.control-dock .panel h3 { font-size: 16px !important; }
</style>


<style id="auto-banner-css">
  #autoLoadBanner{
    position: sticky; top: 0; z-index: 9999;
    background: linear-gradient(90deg, #0047ff 0%, #00b894 100%);
    color: white; padding: .6rem .9rem; border-bottom: 3px solid rgba(0,0,0,.12);
    font-weight: 700; letter-spacing:.2px; text-shadow: 0 1px 0 rgba(0,0,0,.2);
  }
  #autoLoadBanner small{font-weight:400;opacity:.95}
</style>


<style id="dock-wider">
  aside.control-dock { width: 700px !important; }
</style>

</head>
<body>
  <div class="page-shell">
    <header>
      <div class="branding">
        <span class="school-name">Methodist College</span>
      </div>
      <div class="subject-block">
        <span class="subject-label">Subject / 科目</span>
        <div id="subjectDisplay">Awaiting Selection</div>
      </div>
      <div class="timer-block">
        <div id="countdown">00:00:00</div>
        <div id="statusLabel">Awaiting Start</div>
      </div>
      <div class="meta-block">
        <div class="meta-item"><span class="meta-label">Exam Date</span><span class="meta-value" id="scheduledDateDisplay">—</span></div>
        <div class="meta-item"><span class="meta-label">Scheduled Time</span><span class="meta-value" id="scheduledTimeDisplay">—</span></div>
        <div class="meta-item"><span class="meta-label">Venue</span><span class="meta-value" id="venueDisplay">—</span></div>
        <div class="meta-item"><span class="meta-label">Actual Start</span><span class="meta-value" id="actualStartDisplay">—</span></div>
        <div class="meta-item"><span class="meta-label">Estimated End</span><span class="meta-value" id="estimatedEndDisplay">—</span></div>
        <div class="meta-item"><span class="meta-label">Current Time</span><span class="meta-value" id="currentTimeDisplay">—</span></div>
      </div>
    </header>

    <div class="content-scroll">
      <div class="content-grid">
        <main>
          <div id="alertBanner"></div>

          <div class="panels-grid">
            <section class="panel" id="progressPanel">
              <h2>Exam Progress / 考試進度</h2>
              <div class="progress-wrapper">
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
              </div>
              <div class="progress-meta">
                <div class="meta-item"><span class="meta-label">Elapsed</span><span class="meta-value" id="elapsedDisplay">—</span></div>
                <div class="meta-item"><span class="meta-label">Remaining</span><span class="meta-value" id="remainingDisplay">—</span></div>
                <div class="meta-item"><span class="meta-label">Exam State</span><span class="meta-value" id="stateDisplay">Idle</span></div>
                <div class="meta-item"><span class="meta-label">Last Update</span><span class="meta-value" id="lastUpdateDisplay">—</span></div>
              </div>
            </section>

            <section class="panel announcement-board">
              <h2>Announcements / 通告</h2>
              <div class="announcement-list" id="announcementList">
                <div class="meta-value" id="announcementEmpty" style="font-style: italic; color: var(--text-secondary);">
                  No announcements yet. / 暫無通告
                </div>
              </div>
            </section>

            <section class="panel schedule-panel">
              <h2>Exam Schedule / 考試時間表</h2>
              <div class="schedule-list" id="scheduleList">
                <div class="meta-value" style="font-style: italic; color: var(--text-secondary);">
                  No timetable loaded yet. Please import the Excel file from the right.
                </div>
              </div>
            </section>
          </div>
        </main>

        <aside class="control-dock">
          <h2>Invigilator Console 監考控制台</h2>

          <label>
            Color Scheme / 主題色彩
            <select id="themeSelector">
              <option value="midnight">Midnight Navy</option>
              <option value="dawn">Dawn Lilac</option>
              <option value="emerald">Emerald Mist</option>
              <option value="graphite">Graphite Slate</option>
              <option value="sunset">Sunset Bloom</option>
              <option value="aurora">Aurora Borealis</option>
            </select>
          </label>

          <div class="file-loader">
            <label for="excelInput">Load Excel Timetable / 載入 Excel 行程</label>
            <input type="file" id="excelInput" accept=".xlsx,.xls,.csv">
            <span style="font-size: 0.76rem; color: var(--text-secondary);">
              Use the same structure as <strong>exam_html.xlsx</strong>.
            </span>
          </div>

          <div style="font-size: 0.8rem; color: var(--text-secondary);" id="loadStatus">
            No timetable has been loaded yet.
          </div>

          <form id="consoleForm" autocomplete="off">
            <label>
              Select Exam / 選擇考試
              <select id="examSelector">
                <option value="">— Select from schedule —</option>
              </select>
            </label>

            <label>
              Subject / 科目 (manual input allowed)
              <input type="text" id="subjectInput" placeholder="e.g. ENG 1 Reading">
            </label>

            <label>
              Venue / 考場
              <input type="text" id="venueInput" placeholder="e.g. L Hall / E41">
            </label>

            <label>
              Custom Scheduled Date / 日期
              <input type="date" id="customDateInput">
            </label>

            <label>
              Custom Scheduled Time Range / 時段
              <div class="time-range-row">
                <input type="time" id="customStartInput">
                <input type="time" id="customEndInput">
              </div>
            </label>

            <label>
              Optional Note: Scheduled Start Time
              <input type="time" id="startTimeInput">
            </label>

            <label>
              Exam Duration (H : M : S) / 考試時長
              <div class="duration-row">
                <input type="number" id="hoursInput" min="0" max="12" placeholder="0">
                <input type="number" id="minutesInput" min="0" max="59" placeholder="0">
                <input type="number" id="secondsInput" min="0" max="59" placeholder="0">
              </div>
            </label>

            <div class="button-row">
              <button type="button" class="btn-primary" id="startButton">Start</button>
              <button type="button" class="btn-secondary" id="pauseButton" disabled="">Pause</button>
              <button type="button" class="btn-secondary" id="resumeButton" disabled="">Resume</button>
              <button type="button" class="btn-danger" id="resetButton">Reset</button>
            </div>

            <button type="button" class="btn-ghost" id="clearScheduleButton">Clear Schedule / 清空時間表</button>
            <button type="button" class="btn-ghost" id="announcementButton">New Announcement / 發佈通告</button>
          </form>
        </aside>
      </div>
    </div>
  </div>

  <div class="modal" id="announcementModal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <button class="modal-close" id="closeModalButton" aria-label="Close">×</button>
      <h3>Create Announcement / 建立通告</h3>
      <label>
        Title / 標題
        <input type="text" id="announcementTitleInput" placeholder="e.g. Reminder">
      </label>
      <label>
        Message / 內容
        <textarea id="announcementMessageInput" placeholder="Write the announcement details here..."></textarea>
      </label>
      <div class="button-row" style="grid-template-columns: repeat(2, minmax(0, 1fr));">
        <button type="button" class="btn-secondary" id="postAnnouncementButton">Post / 發佈</button>
        <button type="button" class="btn-ghost" id="clearAnnouncementsButton">Clear All / 清除全部</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    (function () {
      const safeStorage = (() => {
        try {
          localStorage.setItem("__theme_test__", "ok");
          localStorage.removeItem("__theme_test__");
          return localStorage;
        } catch {
          return null;
        }
      })();

      const themeSelector = document.getElementById("themeSelector");
      const storedTheme = safeStorage ? safeStorage.getItem("invigilationTheme") : null;
      document.documentElement.setAttribute("data-theme", storedTheme || "midnight");
      themeSelector.value = storedTheme || "midnight";
      themeSelector.addEventListener("change", (event) => {
        const theme = event.target.value;
        document.documentElement.setAttribute("data-theme", theme);
        if (safeStorage) safeStorage.setItem("invigilationTheme", theme);
      });

      const controlDock = document.querySelector(".control-dock");
      controlDock.addEventListener(
        "wheel",
        (event) => {
          const { scrollTop, scrollHeight, clientHeight } = controlDock;
          const delta = event.deltaY;

          if (clientHeight >= scrollHeight) return;

          if (
            (delta > 0 && scrollTop + clientHeight >= scrollHeight) ||
            (delta < 0 && scrollTop <= 0)
          ) {
            event.preventDefault();
          }

          event.stopPropagation();
        },
        { passive: false }
      );

      let touchStartY = 0;
      controlDock.addEventListener(
        "touchstart",
        (event) => {
          if (event.touches.length === 1) touchStartY = event.touches[0].clientY;
        },
        { passive: true }
      );

      controlDock.addEventListener(
        "touchmove",
        (event) => {
          if (event.touches.length !== 1) return;

          const { scrollTop, scrollHeight, clientHeight } = controlDock;
          const touchCurrentY = event.touches[0].clientY;
          const deltaY = touchStartY - touchCurrentY;

          if (clientHeight >= scrollHeight) return;

          if (
            (deltaY > 0 && scrollTop + clientHeight >= scrollHeight) ||
            (deltaY < 0 && scrollTop <= 0)
          ) {
            event.preventDefault();
          }

          event.stopPropagation();
        },
        { passive: false }
      );

      const subjectDisplay = document.getElementById("subjectDisplay");
      const venueDisplay = document.getElementById("venueDisplay");
      const countdownDisplay = document.getElementById("countdown");
      const statusLabel = document.getElementById("statusLabel");
      const scheduledDateDisplay = document.getElementById("scheduledDateDisplay");
      const scheduledTimeDisplay = document.getElementById("scheduledTimeDisplay");
      const actualStartDisplay = document.getElementById("actualStartDisplay");
      const estimatedEndDisplay = document.getElementById("estimatedEndDisplay");
      const currentTimeDisplay = document.getElementById("currentTimeDisplay");
      const elapsedDisplay = document.getElementById("elapsedDisplay");
      const remainingDisplay = document.getElementById("remainingDisplay");
      const stateDisplay = document.getElementById("stateDisplay");
      const lastUpdateDisplay = document.getElementById("lastUpdateDisplay");
      const alertBanner = document.getElementById("alertBanner");
      const progressFill = document.getElementById("progressFill");
      const scheduleList = document.getElementById("scheduleList");
      const loadStatus = document.getElementById("loadStatus");

      const subjectInput = document.getElementById("subjectInput");
      const venueInput = document.getElementById("venueInput");
      const customDateInput = document.getElementById("customDateInput");
      const customStartInput = document.getElementById("customStartInput");
      const customEndInput = document.getElementById("customEndInput");
      const startTimeInput = document.getElementById("startTimeInput");
      const hoursInput = document.getElementById("hoursInput");
      const minutesInput = document.getElementById("minutesInput");
      const secondsInput = document.getElementById("secondsInput");
      const examSelector = document.getElementById("examSelector");
      const excelInput = document.getElementById("excelInput");
      const clearScheduleButton = document.getElementById("clearScheduleButton");
      const startButton = document.getElementById("startButton");
      const pauseButton = document.getElementById("pauseButton");
      const resumeButton = document.getElementById("resumeButton");
      const resetButton = document.getElementById("resetButton");

      const announcementButton = document.getElementById("announcementButton");
      const announcementModal = document.getElementById("announcementModal");
      const closeModalButton = document.getElementById("closeModalButton");
      const postAnnouncementButton = document.getElementById("postAnnouncementButton");
      const clearAnnouncementsButton = document.getElementById("clearAnnouncementsButton");
      const announcementTitleInput = document.getElementById("announcementTitleInput");
      const announcementMessageInput = document.getElementById("announcementMessageInput");
      const announcementList = document.getElementById("announcementList");
      const announcementEmpty = document.getElementById("announcementEmpty");

      const timeFormatter = new Intl.DateTimeFormat("en-GB", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false,
        timeZone: "Asia/Hong_Kong"
      });

      const WEEKDAYS_EN = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      const WEEKDAYS_ZH = ["週日", "週一", "週二", "週三", "週四", "週五", "週六"];
      const MONTHS_EN = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

      const state = {
        countdownInterval: null,
        clockInterval: null,
        examStartTimestamp: null,
        examEndTimestamp: null,
        totalDurationMs: 0,
        remainingMs: 0,
        examState: "idle",
        selectedExamId: null,
        fifteenAlertEligible: false,
        fifteenAlertShown: false,
        fiveAlertShown: false,
        examSchedule: [],
        datasetLabel: "Not loaded"
      };

      function pad(num) {
        return String(num).padStart(2, "0");
      }

      function splitYMD(dateStr) {
        if (!dateStr) return null;
        const parts = dateStr.split("-").map(Number);
        if (parts.length !== 3 || parts.some(Number.isNaN)) return null;
        return { y: parts[0], m: parts[1], d: parts[2] };
      }

      function formatDateLabel(dateStr) {
        const parts = splitYMD(dateStr);
        if (!parts) return dateStr || "—";
        const { y, m, d } = parts;
        const date = new Date(Date.UTC(y, m - 1, d));
        const weekdayIndex = date.getUTCDay();
        const weekdayEn = WEEKDAYS_EN[weekdayIndex];
        const weekdayZh = WEEKDAYS_ZH[weekdayIndex];
        const monthName = MONTHS_EN[m - 1] || pad(m);
        return `${weekdayEn} (${weekdayZh}) · ${pad(d)} ${monthName} ${y}`;
      }

      function formatDuration(ms) {
        const totalSeconds = Math.max(0, Math.floor(ms / 1000));
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
      }

      function formatHumanDuration(ms) {
        const totalSeconds = Math.max(0, Math.floor(ms / 1000));
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        const pieces = [];
        if (hours > 0) pieces.push(`${hours} hr${hours !== 1 ? "s" : ""}`);
        if (hours > 0 || minutes > 0) pieces.push(`${minutes} min`);
        pieces.push(`${seconds} s`);
        return pieces.join(" ");
      }

      function normalizeTime(str) {
        if (!str) return "";
        const match = String(str).trim().match(/^(\d{1,2})(?::(\d{2}))?$/);
        if (!match) return "";
        const hours = Number(match[1]);
        const minutes = Number(match[2] || "0");
        if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) return "";
        return `${pad(hours)}:${pad(minutes)}`;
      }

      function parseTimeRange(raw) {
        if (!raw) return { startTime: "", endTime: "" };
        const sanitized = raw.replace(/[–—]/g, "-").replace(/\s*to\s*/i, "-");
        const parts = sanitized.split("-").map(normalizeTime);
        if (parts[0] && parts[1]) return { startTime: parts[0], endTime: parts[1] };
        if (parts[0]) return { startTime: parts[0], endTime: "" };
        return { startTime: "", endTime: "" };
      }

      function computeDurationMinutes(startTime, endTime) {
        if (!startTime || !endTime) return 0;
        const [sh, sm] = startTime.split(":").map(Number);
        const [eh, em] = endTime.split(":").map(Number);
        const startMinutes = sh * 60 + sm;
        let endMinutes = eh * 60 + em;
        if (endMinutes < startMinutes) endMinutes += 24 * 60;
        return endMinutes - startMinutes;
      }

      function showAlert(message, type = "warning", autoHideMs = 60000) {
        alertBanner.textContent = message;
        alertBanner.className = `show ${type}`;
        if (type !== "final") {
          window.setTimeout(() => {
            if (alertBanner.textContent === message) hideAlert();
          }, autoHideMs);
        }
      }

      function hideAlert() {
        alertBanner.className = "";
        alertBanner.textContent = "";
        alertBanner.style.display = "none";
        requestAnimationFrame(() => {
          alertBanner.style.display = "";
        });
      }

      function setCountdownColor(stateName) {
        countdownDisplay.classList.remove("timer-warning", "timer-danger");
        if (stateName === "warning") countdownDisplay.classList.add("timer-warning");
        if (stateName === "danger") countdownDisplay.classList.add("timer-danger");
      }

      function updateCurrentClock() {
        currentTimeDisplay.textContent = timeFormatter.format(new Date());
      }

      function setExamState(newState) {
        state.examState = newState;
        stateDisplay.textContent = newState.charAt(0).toUpperCase() + newState.slice(1);
        statusLabel.textContent =
          newState === "running"
            ? "Exam In Progress"
            : newState === "paused"
            ? "Paused"
            : newState === "completed"
            ? "Exam Ended"
            : "Awaiting Start";
      }

      function updateDisplays() {
        if (!state.examStartTimestamp || !state.totalDurationMs) return;
        const now = Date.now();
        const elapsed = Math.max(0, now - state.examStartTimestamp);
        const remaining = Math.max(0, state.examEndTimestamp - now);
        elapsedDisplay.textContent = formatHumanDuration(elapsed);
        remainingDisplay.textContent = formatHumanDuration(remaining);
        lastUpdateDisplay.textContent = timeFormatter.format(new Date());
        const progress = Math.min(100, (elapsed / state.totalDurationMs) * 100);
        progressFill.style.width = `${progress}%`;
      }

      function updateTimer() {
        if (!state.examEndTimestamp) return;
        const now = Date.now();
        state.remainingMs = state.examEndTimestamp - now;

        if (state.remainingMs <= 0) {
          clearInterval(state.countdownInterval);
          state.countdownInterval = null;
          countdownDisplay.textContent = "00:00:00";
          setCountdownColor("normal");
          setExamState("completed");
          showAlert("Exam period complete / 考試時間完結", "final", 15000);
          progressFill.style.width = "100%";
          remainingDisplay.textContent = "0 s";
          return;
        }

        countdownDisplay.textContent = formatDuration(state.remainingMs);
        updateDisplays();

        if (state.remainingMs <= 5 * 60 * 1000) {
          if (!state.fiveAlertShown) {
            state.fiveAlertShown = true;
            showAlert("Final 5 minutes / 剩餘五分鐘", "danger");
          }
          setCountdownColor("danger");
        } else if (state.remainingMs <= 15 * 60 * 1000) {
          if (state.fifteenAlertEligible && !state.fifteenAlertShown) {
            state.fifteenAlertShown = true;
            showAlert("15 minutes remaining / 剩餘十五分鐘", "warning");
          }
          setCountdownColor("warning");
        } else {
          setCountdownColor("normal");
        }
      }

      function startExam() {
        const hours = parseInt(hoursInput.value, 10) || 0;
        const minutes = parseInt(minutesInput.value, 10) || 0;
        const seconds = parseInt(secondsInput.value, 10) || 0;
        state.totalDurationMs = ((hours * 3600) + (minutes * 60) + seconds) * 1000;

        if (state.totalDurationMs <= 0) {
          window.alert("Please enter a valid exam duration.");
          return;
        }

        state.fifteenAlertEligible = state.totalDurationMs >= 15 * 60 * 1000;
        state.fifteenAlertShown = false;
        state.fiveAlertShown = false;
        hideAlert();
        setCountdownColor("normal");

        state.examStartTimestamp = Date.now();
        state.examEndTimestamp = state.examStartTimestamp + state.totalDurationMs;

        countdownDisplay.textContent = formatDuration(state.totalDurationMs);
        actualStartDisplay.textContent = timeFormatter.format(new Date(state.examStartTimestamp));
        estimatedEndDisplay.textContent = timeFormatter.format(new Date(state.examEndTimestamp));

        clearInterval(state.countdownInterval);
        state.countdownInterval = setInterval(updateTimer, 1000);
        updateTimer();

        if (!state.clockInterval) state.clockInterval = setInterval(updateCurrentClock, 1000);
        updateCurrentClock();

        setExamState("running");
        startButton.disabled = true;
        pauseButton.disabled = false;
        resumeButton.disabled = true;
      }

      function pauseExam() {
        if (!state.countdownInterval) return;
        clearInterval(state.countdownInterval);
        state.countdownInterval = null;
        if (state.examEndTimestamp) state.remainingMs = state.examEndTimestamp - Date.now();
        setExamState("paused");
        pauseButton.disabled = true;
        resumeButton.disabled = false;
      }

      function resumeExam() {
        if (!state.remainingMs || state.remainingMs <= 0) return;
        state.examStartTimestamp = Date.now();
        state.examEndTimestamp = state.examStartTimestamp + state.remainingMs;
        estimatedEndDisplay.textContent = timeFormatter.format(new Date(state.examEndTimestamp));
        state.countdownInterval = setInterval(updateTimer, 1000);
        updateTimer();
        setExamState("running");
        pauseButton.disabled = false;
        resumeButton.disabled = true;
      }

      function resetExam(preserveSelection = false) {
        clearInterval(state.countdownInterval);
        state.countdownInterval = null;
        state.examStartTimestamp = null;
        state.examEndTimestamp = null;
        state.totalDurationMs = 0;
        state.remainingMs = 0;
        state.fifteenAlertEligible = false;
        state.fifteenAlertShown = false;
        state.fiveAlertShown = false;

        countdownDisplay.textContent = "00:00:00";
        setCountdownColor("normal");
        hideAlert();
        elapsedDisplay.textContent = "—";
        remainingDisplay.textContent = "—";
        lastUpdateDisplay.textContent = "—";
        progressFill.style.width = "0%";
        actualStartDisplay.textContent = "—";
        estimatedEndDisplay.textContent = "—";

        startButton.disabled = false;
        pauseButton.disabled = true;
        resumeButton.disabled = true;
        setExamState("idle");

        updateScheduledDisplays();

        if (!preserveSelection) {
          state.selectedExamId = null;
          examSelector.value = "";
          highlightSchedule(null);
        }
      }

      function updateScheduledDisplays() {
        scheduledDateDisplay.textContent = customDateInput.value ? formatDateLabel(customDateInput.value) : "—";
        const startVal = customStartInput.value;
        const endVal = customEndInput.value;
        scheduledTimeDisplay.textContent = startVal && endVal ? `${startVal} - ${endVal}` : (startVal || endVal || "—");
      }

      function highlightSchedule(examId) {
        document.querySelectorAll(".schedule-item").forEach((item) => {
          item.classList.toggle("active", item.dataset.examId === examId);
        });
      }

      function populateExamSelector() {
        examSelector.innerHTML = '<option value="">— Select from schedule —</option>';
        state.examSchedule.forEach((exam) => {
          const option = document.createElement("option");
          option.value = exam.id;
          const timeLabel = exam.startTime && exam.endTime ? `${exam.startTime}-${exam.endTime}` : (exam.startTime || "Time TBC");
          option.textContent = `${formatDateLabel(exam.date)} • ${timeLabel} • ${exam.subject || "Untitled"}`;
          examSelector.appendChild(option);
        });
      }

      function renderSchedule() {
        scheduleList.innerHTML = "";
        if (!state.examSchedule.length) {
          scheduleList.innerHTML =
            '<div class="meta-value" style="font-style: italic; color: var(--text-secondary);">No timetable loaded yet. Please import the Excel file from the right.</div>';
          return;
        }

        const grouped = state.examSchedule.reduce((map, exam) => {
          const key = exam.date || "Date TBC";
          if (!map.has(key)) map.set(key, []);
          map.get(key).push(exam);
          return map;
        }, new Map());

        Array.from(grouped.keys())
          .sort()
          .forEach((date) => {
            const groupElement = document.createElement("div");
            groupElement.className = "schedule-group";

            const heading = document.createElement("h3");
            heading.className = "schedule-date-heading";
            heading.textContent = date === "Date TBC" ? "Date TBC" : formatDateLabel(date);
            groupElement.appendChild(heading);

            grouped.get(date).forEach((exam) => {
              const item = document.createElement("div");
              item.className = "schedule-item";
              item.dataset.examId = exam.id;

              const time = document.createElement("div");
              time.className = "time";
              time.textContent = exam.startTime && exam.endTime ? `${exam.startTime} - ${exam.endTime}` : (exam.startTime || "Time TBC");
              item.appendChild(time);

              const subject = document.createElement("div");
              subject.className = "subject";
              subject.textContent = exam.subject || "Untitled";
              item.appendChild(subject);

              const venue = document.createElement("div");
              venue.className = "venue";
              venue.textContent = `Venue: ${exam.venue || "TBC"}`;
              item.appendChild(venue);

              item.addEventListener("click", () => {
                if (state.examState === "running") {
                  const proceed = window.confirm("Timer is running. Switching exams will reset it. Continue?");
                  if (!proceed) return;
                }
                examSelector.value = exam.id;
                applyExamDetails(exam.id);
              });

              groupElement.appendChild(item);
            });

            scheduleList.appendChild(groupElement);
          });

        highlightSchedule(state.selectedExamId);
      }

      function updateLoadStatus() {
        const count = state.examSchedule.length;
        loadStatus.textContent = count
          ? `Loaded: ${state.datasetLabel} (${count} exam${count === 1 ? "" : "s"})`
          : "No timetable has been loaded yet.";
      }

      function setExamSchedule(data, label = "Loaded file") {
        state.examSchedule = data
          .map((exam, index) => ({
            ...exam,
            id: exam.id || `exam-${Date.now()}-${index}`
          }))
          .sort((a, b) => {
            const dateA = new Date(`${a.date || "2100-01-01"}T${a.startTime || "00:00"}`);
            const dateB = new Date(`${b.date || "2100-01-01"}T${b.startTime || "00:00"}`);
            return dateA - dateB;
          });

        state.datasetLabel = label;
        state.selectedExamId = null;
        populateExamSelector();
        renderSchedule();
        resetExam(false);
        subjectDisplay.textContent = "Awaiting Selection";
        scheduledDateDisplay.textContent = "—";
        scheduledTimeDisplay.textContent = "—";
        venueDisplay.textContent = "—";
        updateLoadStatus();
      }

      function applyExamDetails(examId) {
        const exam = state.examSchedule.find((entry) => entry.id === examId);
        if (!exam) return;

        if (state.examState === "running") {
          const proceed = window.confirm("Timer is running. Switching exams will reset it. Continue?");
          if (!proceed) {
            examSelector.value = state.selectedExamId || "";
            return;
          }
        }

        state.selectedExamId = examId;

        subjectDisplay.textContent = exam.subject || "Awaiting Selection";
        subjectInput.value = exam.subject || "";
        venueDisplay.textContent = exam.venue || "—";
        venueInput.value = exam.venue || "";

        customDateInput.value = exam.date || "";
        customStartInput.value = exam.startTime || "";
        customEndInput.value = exam.endTime || "";
        startTimeInput.value = exam.startTime || "";

        updateScheduledDisplays();

        if (exam.durationMinutes) {
          hoursInput.value = Math.floor(exam.durationMinutes / 60);
          minutesInput.value = exam.durationMinutes % 60;
          secondsInput.value = 0;
        } else {
          hoursInput.value = "";
          minutesInput.value = "";
          secondsInput.value = "";
        }

        scheduledDateDisplay.textContent = exam.date ? formatDateLabel(exam.date) : "—";
        scheduledTimeDisplay.textContent = exam.startTime && exam.endTime ? `${exam.startTime} - ${exam.endTime}` : (exam.startTime || exam.endTime || "—");

        resetExam(true);
        highlightSchedule(examId);
      }

      function parseExcelDate(value) {
        if (value == null || value === "") return "";

        if (value instanceof Date && !Number.isNaN(value.getTime())) {
          return `${value.getFullYear()}-${pad(value.getMonth() + 1)}-${pad(value.getDate())}`;
        }

        if (typeof value === "number" && Number.isFinite(value)) {
          const parsed = XLSX.SSF.parse_date_code(value);
          if (parsed) {
            return `${parsed.y}-${pad(parsed.m)}-${pad(parsed.d)}`;
          }
        }

        if (typeof value === "string") {
          const trimmed = value.trim();
          if (!trimmed) return "";

          if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(trimmed)) {
            const [y, m, d] = trimmed.split("-").map(Number);
            return `${y}-${pad(m)}-${pad(d)}`;
          }

          if (/^\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}$/.test(trimmed)) {
            const [dVal, mVal, yRaw] = trimmed.split(/[\/\-]/);
            const yVal = yRaw.length === 2 ? Number(`20${yRaw}`) : Number(yRaw);
            return `${yVal}-${pad(Number(mVal))}-${pad(Number(dVal))}`;
          }

          const parsedDate = new Date(trimmed);
          if (!Number.isNaN(parsedDate.getTime())) {
            return `${parsedDate.getFullYear()}-${pad(parsedDate.getMonth() + 1)}-${pad(parsedDate.getDate())}`;
          }
        }

        return "";
      }

      function parseTimeValue(raw) {
        if (raw == null || raw === "") return "";
        if (typeof raw === "number" && Number.isFinite(raw)) {
          const parsed = XLSX.SSF.parse_date_code(raw);
          if (parsed) {
            const totalMinutes = parsed.H * 60 + parsed.M + Math.round(parsed.S / 60);
            const hours = Math.floor(totalMinutes / 60) % 24;
            const minutes = totalMinutes % 60;
            return `${pad(hours)}:${pad(minutes)}`;
          }
        }

        const sanitized = String(raw).trim().replace(/[–—]/g, "-").replace(/\s*to\s*/i, "-");
        if (sanitized.includes("-")) return sanitized;
        return normalizeTime(sanitized);
      }

      function parseExcelRows(rows) {
        if (!rows.length) return [];
        const dataRows = rows.slice(1);
        const parsed = [];
        let lastDate = "";

        dataRows.forEach((row, rowIndex) => {
          if (!row || !row.length) return;

          const maybeDate = parseExcelDate(row[0]);
          if (maybeDate) lastDate = maybeDate;

          for (let offset = 1; offset < row.length; offset += 3) {
            const timeCell = parseTimeValue(row[offset]);
            const subjectCell = row[offset + 1];
            const venueCell = row[offset + 2];

            const subject = subjectCell ? String(subjectCell).trim() : "";
            const venue = venueCell ? String(venueCell).trim() : "";

            if (!subject && !timeCell && !venue) continue;

            let startTime = "";
            let endTime = "";
            if (timeCell) {
              if (timeCell.includes("-")) {
                const range = parseTimeRange(timeCell);
                startTime = range.startTime;
                endTime = range.endTime;
              } else {
                startTime = normalizeTime(timeCell);
              }
            }

            parsed.push({
              id: `excel-${Date.now()}-${rowIndex}-${offset}`,
              subject,
              date: maybeDate || lastDate || "",
              startTime,
              endTime,
              durationMinutes: startTime && endTime ? computeDurationMinutes(startTime, endTime) : 0,
              venue: venue || "—"
            });
          }
        });

        return parsed.filter((entry) => entry.subject || entry.startTime || entry.endTime || entry.venue);
      }

      excelInput.addEventListener("change", (event) => {
        const file = event.target.files ? event.target.files[0] : null;
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: "array", cellDates: true });
            const sheetName = workbook.SheetNames.find((name) => name.toLowerCase().includes("sheet2")) || workbook.SheetNames[0];
            if (!sheetName) throw new Error("No worksheet found in the file.");
            const worksheet = workbook.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: true, blankrows: false });
            const parsed = parseExcelRows(rows);
            if (!parsed.length) {
              window.alert("No exam entries were detected. Please check the Excel structure.");
              return;
            }
            setExamSchedule(parsed, file.name);
            showAlert(`Timetable loaded: ${file.name}`, "final", 12000);
          } catch (error) {
            console.error(error);
            window.alert(`Excel import failed: ${error.message || error}`);
          } finally {
            excelInput.value = "";
          }
        };
        reader.onerror = () => window.alert("File reading error. Please try again.");
        reader.readAsArrayBuffer(file);
      });

      clearScheduleButton.addEventListener("click", () => {
        setExamSchedule([], "Not loaded");
        showAlert("Timetable cleared.", "warning", 8000);
      });

      examSelector.addEventListener("change", (event) => {
        applyExamDetails(event.target.value);
      });

      startButton.addEventListener("click", startExam);
      pauseButton.addEventListener("click", pauseExam);
      resumeButton.addEventListener("click", resumeExam);
      resetButton.addEventListener("click", () => resetExam(false));

      subjectInput.addEventListener("input", () => {
        subjectDisplay.textContent = subjectInput.value.trim() || "Awaiting Selection";
        if (subjectInput.value.trim()) {
          state.selectedExamId = null;
          examSelector.value = "";
          highlightSchedule(null);
        }
      });

      venueInput.addEventListener("input", () => {
        venueDisplay.textContent = venueInput.value.trim() || "—";
      });

      function handleScheduleInputs() {
        updateScheduledDisplays();
        if (customStartInput.value && customEndInput.value) {
          const minutes = computeDurationMinutes(customStartInput.value, customEndInput.value);
          if (minutes > 0) {
            hoursInput.value = Math.floor(minutes / 60);
            minutesInput.value = minutes % 60;
            secondsInput.value = 0;
          }
        }
        state.selectedExamId = null;
        examSelector.value = "";
        highlightSchedule(null);
      }

      customDateInput.addEventListener("input", handleScheduleInputs);
      customStartInput.addEventListener("input", handleScheduleInputs);
      customEndInput.addEventListener("input", handleScheduleInputs);
      startTimeInput.addEventListener("input", updateScheduledDisplays);

      announcementButton.addEventListener("click", () => {
        announcementModal.classList.add("show");
        setTimeout(() => announcementTitleInput.focus(), 60);
      });

      function closeAnnouncementModal() {
        announcementModal.classList.remove("show");
        announcementTitleInput.value = "";
        announcementMessageInput.value = "";
      }

      closeModalButton.addEventListener("click", closeAnnouncementModal);
      announcementModal.addEventListener("click", (event) => {
        if (event.target === announcementModal) closeAnnouncementModal();
      });

      function renderAnnouncement(title, message) {
        const card = document.createElement("article");
        card.className = "announcement-card";

        const cardHeader = document.createElement("header");
        const heading = document.createElement("h3");
        heading.textContent = title || "Announcement";
        const timeStamp = document.createElement("time");
        const now = new Date();
        timeStamp.dateTime = now.toISOString();
        timeStamp.textContent = timeFormatter.format(now);
        cardHeader.appendChild(heading);
        cardHeader.appendChild(timeStamp);

        const body = document.createElement("p");
        body.textContent = message;

        card.appendChild(cardHeader);
        card.appendChild(body);
        announcementList.prepend(card);
      }

      postAnnouncementButton.addEventListener("click", () => {
        const title = announcementTitleInput.value.trim();
        const message = announcementMessageInput.value.trim();
        if (!message) {
          window.alert("Please enter announcement content.");
          return;
        }
        if (announcementEmpty && announcementEmpty.parentElement) {
          announcementEmpty.remove();
        }
        renderAnnouncement(title, message);
        closeAnnouncementModal();
      });

      clearAnnouncementsButton.addEventListener("click", () => {
        announcementList.innerHTML = "";
        if (announcementEmpty) announcementList.appendChild(announcementEmpty);
      });

      function updateLoadAndSchedule() {
        populateExamSelector();
        renderSchedule();
        updateLoadStatus();
      }

      updateLoadAndSchedule();
      updateCurrentClock();
      state.clockInterval = setInterval(updateCurrentClock, 1000);
    })();
  </script>



  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.1/dist/jspdf.plugin.autotable.min.js"></script>


<script>
(function(){
  const INIT_RETRY_MS = 250;
  const INIT_MAX_TRIES = 40; // ~10s

  function ensureDock() {
    let dock = document.querySelector("aside.control-dock");
    if (!dock) {
      dock = document.createElement("aside");
      dock.className = "control-dock";
      dock.style.maxHeight = "100vh";
      dock.style.overflow = "auto";
      document.body.appendChild(dock);
    }
    return dock;
  }

  // ---- GitHub Excel fetch ----
  async function fetchExcelFromRepo(filename) {
    const url = encodeURI("./" + filename);
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`Fetch failed (${res.status}) for: ${filename}`);
    const buf = await res.arrayBuffer();
    const workbook = XLSX.read(new Uint8Array(buf), { type: "array", cellDates: true });
    return workbook;
  }

  async function fetchFirstExisting(names) {
    for (const name of names) {
      try {
        const wb = await fetchExcelFromRepo(name);
        return { name, wb };
      } catch (e) {}
    }
    throw new Error("None of the candidate files were found: " + names.join(", "));
  }

  // ---- Flexible roster indices ----
  const rosterByClassCode = new Map();
  const rosterByClass     = new Map();
  const rosterByClassNo   = new Map();
  function normalizeClass(v){ return String(v||"").trim().toUpperCase().replace(/\s+/g,""); }
  function normalizeNo(v){ const s=String(v||"").trim(); return /^\d+$/.test(s) ? s.padStart(2,"0") : s; }
  function classNoKey(cls,no){ return `${normalizeClass(cls)}-${normalizeNo(no)}`; }

  function parseRosterWorkbook(workbook){
    const sheetName = workbook.SheetNames.find((n)=>n.toLowerCase().includes("roster")) || workbook.SheetNames[0];
    const ws = workbook.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(ws, { header:1, raw:true, blankrows:false });
    if(!rows.length) throw new Error("Roster sheet is empty");
    const headers = rows[0].map(h=>String(h||"").trim().toLowerCase());
    const idx = {
      classCode: headers.findIndex(h=>/(classcode|class_code|cls_code)/.test(h)),
      class: headers.findIndex(h=>/^(\u73ed|class|cls)$/.test(h) || /^class\s*$/.test(h)),
      no: headers.findIndex(h=>/^(no|number|index|classno|class no|class_number|seat|roll)$/.test(h)),
      name: headers.findIndex(h=>/name/.test(h)),
      candidate: headers.findIndex(h=>/(candidate|cand)/.test(h)),
    };
    if(idx.name===-1 || (idx.classCode===-1 && idx.class===-1)){
      throw new Error("Roster must include 'Name' and either 'ClassCode' or 'Class' column.");
    }

    rosterByClassCode.clear(); rosterByClass.clear(); rosterByClassNo.clear();
    for(let r=1;r<rows.length;r++){
      const row = rows[r] || [];
      const rawClassCode = idx.classCode!==-1 && row[idx.classCode]!=null ? String(row[idx.classCode]) : "";
      const rawClass     = idx.class!==-1 && row[idx.class]!=null ? String(row[idx.class]) : "";
      const rawNo        = idx.no!==-1 && row[idx.no]!=null ? String(row[idx.no]) : "";
      const nameVal      = idx.name!==-1 && row[idx.name]!=null ? String(row[idx.name]) : "";
      const candVal      = idx.candidate!==-1 && row[idx.candidate]!=null ? String(row[idx.candidate]) : "";
      if(!nameVal) continue;
      const student = { name: nameVal.trim(), candidate: candVal.trim(), class: normalizeClass(rawClass)||undefined, no: normalizeNo(rawNo)||undefined };
      const ccode = normalizeClass(rawClassCode);
      const cls = student.class;
      const no  = student.no;
      if(ccode){ if(!rosterByClassCode.has(ccode)) rosterByClassCode.set(ccode, []); rosterByClassCode.get(ccode).push(student); }
      if(cls){ if(!rosterByClass.has(cls)) rosterByClass.set(cls, []); rosterByClass.get(cls).push(student); }
      if(cls && no){ const key = classNoKey(cls,no); if(!rosterByClassNo.has(key)) rosterByClassNo.set(key, []); rosterByClassNo.get(key).push(student); }
    }
  }

  function findCandidates(query){
    const { classCode, cls, no } = query || {};
    if(classCode) return rosterByClassCode.get(normalizeClass(classCode)) || [];
    if(cls && no) return rosterByClassNo.get(classNoKey(cls,no)) || [];
    if(cls) return rosterByClass.get(normalizeClass(cls)) || [];
    return [];
  }

  // ---- UI ----
  function addUI(appApis) {
    const { parseExcelRows, setExamSchedule, showAlert } = appApis;
    const dock = ensureDock();

      // Sticky banner to prove new build is active
      const banner = document.createElement("div");
      banner.id = "autoLoadBanner";
      banner.innerHTML = 'AUTO‑LOAD MODE ACTIVE <small>(V3.7)</small>';
      document.body.prepend(banner);


      // ---- Data Status panel ----
      const status = document.createElement("section");
      status.className = "panel";
      status.id = "dataStatusPanel";
      status.innerHTML = `
        <h2>Data Status</h2>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem;">
          <div id="rosterStatus" style="padding:.6rem;border:1px solid var(--panel-border);border-radius:10px;">Roster: <span>Loading…</span></div>
          <div id="timetableStatus" style="padding:.6rem;border:1px solid var(--panel-border);border-radius:10px;">Timetable: <span>Waiting…</span></div>
        </div>
      `;
      dock.prepend(status);
      function setRosterStatus(text, ok){
        const el = status.querySelector("#rosterStatus span");
        el.textContent = text;
        status.querySelector("#rosterStatus").style.background = ok ? "rgba(0,160,0,.08)" : "rgba(200,0,0,.06)";
      }
      function setTimetableStatus(text, ok){
        const el = status.querySelector("#timetableStatus span");
        el.textContent = text;
        status.querySelector("#timetableStatus").style.background = ok ? "rgba(0,160,0,.08)" : "rgba(200,0,0,.06)";
      }


    // Invigilation Records (no manual loader UI)
    const issuesBlock = document.createElement("section");
    issuesBlock.className = "panel";
    issuesBlock.innerHTML = `
      <h2>Invigilation Records 記錄</h2>
      <label>Chief Invigilator / 主監考 (required)
        <input type="text" id="chiefInvigilatorInput" placeholder="Full name" required>
      </label>
      <label>Other Invigilators / 其他監考 (optional, comma-separated)
        <input type="text" id="otherInvigilatorsInput" placeholder="Name A, Name B">
      </label>
      <div class="schedule-group">
        <h3 class="schedule-date-heading">Student Issues / 學生情況</h3>
        <div class="button-row" style="display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:.4rem;">
          <button type="button" class="btn-secondary" data-add="absent">Add Absentee</button>
          <button type="button" class="btn-secondary" data-add="late">Add Late Comer</button>
          <button type="button" class="btn-secondary" data-add="idcheck">Add Student ID</button>
        </div>
        <div class="button-row" style="display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:.4rem;margin-top:.5rem;">
          <button type="button" class="btn-secondary" data-add="washroom">Add Washroom</button>
          <button type="button" class="btn-secondary" data-add="uniform">Add Improper Uniform</button>
        </div>
        <div id="issuesContainer" style="display:grid; gap:.6rem; margin-top:.8rem;"></div>
      </div>
      <div class="schedule-group">
        <h3 class="schedule-date-heading">Irregularity (optional) / 非正規情況（可選）</h3>
        <textarea id="irregularityInput" placeholder="Describe any irregularities if any..."></textarea>
      </div>
      <div class="button-row" style="display:grid;grid-template-columns:1fr;gap:.4rem;">
        <button type="button" class="btn-primary" id="btnGeneratePdf">Generate PDF Report</button>
      </div>
    `;
    dock.appendChild(issuesBlock);

    const records = { absent: [], late: [], idcheck: [], washroom: [], uniform: [] };

    function makeIssueRow(kind) {
      const row = document.createElement("div");
      row.style.border = "1px solid var(--panel-border)";
      row.style.borderRadius = "12px";
      row.style.padding = ".6rem";
      row.style.display = "grid";
      row.style.gap = ".5rem";

      row.innerHTML = `
        <div style="display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:.5rem;">
          <label>Class<input type="text" data-field="class" placeholder="e.g. 1B"></label>
          <label>Class No<input type="text" data-field="classNo" placeholder="e.g. 02"></label>
          <label>Candidate Name<select data-field="name"><option value="">—</option></select></label>
        </div>
        <label>Manual Name (if not in roster)<input type="text" data-field="nameManual" placeholder="Type name if needed"></label>
        <div data-extra></div>
        <div style="display:flex; gap:.5rem; justify-content:flex-end;">
          <button type="button" class="btn-ghost" data-action="remove">Remove</button>
          <button type="button" class="btn-secondary" data-action="save">Save</button>
        </div>
      `;

      const extra = row.querySelector("[data-extra]");
      if (kind === "late") {
        extra.innerHTML = `<label>Minutes Late<input type="number" min="0" data-field="minutesLate" placeholder="e.g. 5"></label>`;
      } else if (kind === "washroom") {
        extra.innerHTML = `
          <div style="display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:.5rem;">
            <label>Out Time<input type="time" data-field="outTime"></label>
            <label>In Time<input type="time" data-field="inTime"></label>
          </div>`;
      } else {
        extra.innerHTML = `<label>Note / 備註<textarea data-field="note" placeholder="Optional notes..."></textarea></label>`;
      }

      const nameSelect = row.querySelector('[data-field="name"]');
      function refreshNameOptions() {
        const cls = row.querySelector('[data-field="class"]').value.trim();
        const no  = row.querySelector('[data-field="classNo"]').value.trim();
        const list = findCandidates({ cls, no });
        nameSelect.innerHTML = `<option value="">—</option>` + list.map(s => {
          const label = s.candidate ? `${s.name} (${s.candidate})` : s.name;
          return `<option value="${s.name}">${label}</option>`;
        }).join("");
        if (no && list.length === 1) nameSelect.value = list[0].name;
      }
      row.querySelector('[data-field="class"]').addEventListener("input", refreshNameOptions);
      row.querySelector('[data-field="classNo"]').addEventListener("input", refreshNameOptions);

      row.querySelector('[data-action="remove"]').addEventListener("click", () => row.remove());
      row.querySelector('[data-action="save"]').addEventListener("click", () => {
        const cls = row.querySelector('[data-field="class"]').value.trim();
        const classNo = row.querySelector('[data-field="classNo"]').value.trim();
        const selectedName = nameSelect.value.trim();
        const manualName   = row.querySelector('[data-field="nameManual"]').value.trim();
        const finalName    = selectedName || manualName;
        if (!cls || !finalName) { alert("Please provide Class and a Candidate Name (from roster or manual)."); return; }
        const entry = { class: cls, classNo, name: finalName };
        if (kind === "late") {
          entry.minutesLate = parseInt(row.querySelector('[data-field="minutesLate"]').value, 10) || 0;
        } else if (kind === "washroom") {
          entry.outTime = row.querySelector('[data-field="outTime"]').value || "";
          entry.inTime  = row.querySelector('[data-field="inTime"]').value || "";
        } else {
          entry.note = row.querySelector('[data-field="note"]').value || "";
        }
        records[kind].push(entry);
        row.style.opacity = "0.6";
        row.querySelectorAll("input,select,textarea,button").forEach(el => el.disabled = true);
      });

      return row;
    }

    const issuesContainer = issuesBlock.querySelector("#issuesContainer");
    issuesBlock.querySelectorAll("button[data-add]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const kind = btn.getAttribute("data-add");
        issuesContainer.prepend(makeIssueRow(kind));
      });
    });

    function getExamHeaderInfo() {
      const subject = document.getElementById("subjectDisplay")?.textContent.trim() || "";
      const venue   = document.getElementById("venueDisplay")?.textContent.trim() || "";
      const date    = document.getElementById("scheduledDateDisplay")?.textContent.trim() || "";
      const time    = document.getElementById("scheduledTimeDisplay")?.textContent.trim() || "";
      const chief   = document.getElementById("chiefInvigilatorInput").value.trim();
      const others  = document.getElementById("otherInvigilatorsInput").value.trim();
      return { subject, venue, date, time, chief, others };
    }

    function tableFrom(kind, rows) {
      if (!rows.length) return null;
      const headersByKind = {
        absent: ["Class", "Class No", "Name", "Note"],
        late: ["Class", "Class No", "Name", "Minutes Late"],
        idcheck: ["Class", "Class No", "Name", "Note"],
        washroom: ["Class", "Class No", "Name", "Out Time", "In Time"],
        uniform: ["Class", "Class No", "Name", "Note"]
      };
      const cols = headersByKind[kind];
      const body = rows.map(r => {
        if (kind === "late") return [r.class || "", r.classNo || "", r.name, String(r.minutesLate || 0)];
        if (kind === "washroom") return [r.class || "", r.classNo || "", r.name, r.outTime || "", r.inTime || ""];
        return [r.class || "", r.classNo || "", r.name, r.note || ""];
      });
      return { columns: cols, body };
    }

    issuesBlock.querySelector("#btnGeneratePdf").addEventListener("click", () => {
      const irregularity = document.getElementById("irregularityInput").value.trim();
      const info = getExamHeaderInfo();
      if (!info.chief) { alert("Chief Invigilator is required."); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "a4" });

      doc.setFontSize(14);
      doc.text("Methodist College — Exam Invigilation Report", 40, 40);
      doc.setFontSize(11);
      doc.text(`Subject: ${info.subject}`, 40, 60);
      doc.text(`Date: ${info.date}`, 40, 78);
      doc.text(`Time: ${info.time}`, 250, 78);
      doc.text(`Venue: ${info.venue}`, 40, 96);
      doc.text(`Chief Invigilator: ${info.chief}`, 40, 114);
      if (info.others) doc.text(`Other Invigilators: ${info.others}`, 40, 132);

      const counts = {
        Absentees: records.absent.length,
        "Late Comers": records.late.length,
        "Student ID Checks": records.idcheck.length,
        "Washroom": records.washroom.length,
        "Improper Uniform": records.uniform.length
      };
      let y = 158;
      doc.setFontSize(12);
      doc.text("Summary", 40, y);
      y += 6;
      doc.setFontSize(10);
      Object.entries(counts).forEach(([k,v]) => { y += 14; doc.text(`${k}: ${v}`, 50, y); });

      const allKinds = ["absent","late","idcheck","washroom","uniform"];
      y += 26;
      allKinds.forEach((k) => {
        const tbl = tableFrom(k, records[k]);
        if (!tbl) return;
        doc.setFontSize(12);
        doc.text(k.toUpperCase(), 40, y);
        y += 6;
        doc.autoTable({
          startY: y + 8,
          head: [tbl.columns],
          body: tbl.body,
          margin: { left: 40, right: 40 },
          styles: { fontSize: 9 }
        });
        y = doc.lastAutoTable.finalY + 16;
      });

      if (irregularity) {
        doc.setFontSize(12);
        doc.text("Irregularity (if any)", 40, y);
        y += 10;
        doc.setFontSize(10);
        const lines = doc.splitTextToSize(irregularity, 515);
        doc.text(lines, 40, y + 12);
      }

      doc.save("invigilation_report.pdf");
    });

    
  
  // ---- Auto-load roster then timetable (STRICT FILENAMES) ----
  (async () => {
    function log(...args){ try{ console.log("[INVIGILATION]", ...args); }catch(e){} }

    async function fetchExact(name) {
      log("Fetching", name);
      const url = encodeURI("./" + name);
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`Fetch failed (${res.status}) for: ${name}`);
      const buf = await res.arrayBuffer();
      const wb = XLSX.read(new Uint8Array(buf), { type: "array", cellDates: true });
      return { name, wb };
    }

    // 1) Roster (strict: roster.xlsx only)
    try {
      const r = await fetchExact("roster.xlsx");
      parseRosterWorkbook(r.wb);
      const count = Array.from(rosterByClass.values()).reduce((a,arr)=>a+arr.length,0)
                    || Array.from(rosterByClassCode.values()).reduce((a,arr)=>a+arr.length,0);
      setRosterStatus(`Loaded (${count} students)`, true);
      log("Roster loaded:", r.name, "students:", count);
    } catch (e) {
      setRosterStatus("Not found (expect: roster.xlsx)", false);
      log("Roster load failed:", e);
    }

    // 2) Timetable (strict: timetable_exam.xlsx only)
    try {
      const t = await fetchExact("timetable_exam.xlsx");
      let best = { name: "", rows: [], parsed: [], count: -1 };
      for (const sName of t.wb.SheetNames) {
        const ws = t.wb.Sheets[sName];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true, blankrows: false });
        const parsed = parseExcelRows(rows);
        const count = (parsed && parsed.length) ? parsed.length : 0;
        if (count > best.count) best = { name: sName, rows, parsed, count };
      }
      if (best.count > 0) {
        setExamSchedule(best.parsed, t.name + " / " + best.name);
        setTimetableStatus(`Loaded (${best.count} entries)`, true);
        log("Timetable loaded:", t.name, "sheet:", best.name, "entries:", best.count);
      } else {
        setTimetableStatus("Found file but could not parse rows", false);
        log("Timetable parse returned 0 entries for all sheets", t.name);
      }
    } catch (e) {
      setTimetableStatus("Not found (expect: timetable_exam.xlsx)", false);
      log("Timetable load failed:", e);
    }
  })();

  function collectAppApis
(
) {
    return {
      parseExcelRows: window.parseExcelRows || window.App?.parseExcelRows,
      setExamSchedule: window.setExamSchedule || window.App?.setExamSchedule,
      showAlert: window.showAlert || window.App?.showAlert,
    };
  }

  function tryInit(tries=0) {
    const xlsxReady = !!window.XLSX;
    const apis = collectAppApis();
    const apisReady = apis.parseExcelRows && apis.setExamSchedule;
    if (xlsxReady && apisReady) {
      addUI(apis);
    } else if (tries < 40) {
      setTimeout(() => tryInit(tries+1), 250);
    } else {
      addUI({ parseExcelRows: (rows)=>rows, setExamSchedule: ()=>alert("Core app API not ready; cannot set schedule."), showAlert: (m)=>console.log(m) });
    }
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => tryInit());
  } else {
    tryInit();
  }
})();
</script>

</body></html>
