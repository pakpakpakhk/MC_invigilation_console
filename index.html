<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Methodist College – Exam Invigilation Console (Auto-Load V3.9)</title>

<!-- SheetJS (XLSX) + jsPDF + AutoTable -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.1/dist/jspdf.plugin.autotable.min.js"></script>

<style>
  :root{
    --panel-bg:#fff; --panel-border:#ddd; --ink:#111; --muted:#555; --accent:#0047ff;
    --bg:#f6f7fb;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink); background:var(--bg);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    display:grid; grid-template-columns: 1fr auto; gap: 16px;
  }

  /* Banner */
  #autoLoadBanner{
    position: sticky; top: 0; grid-column:1/-1;
    z-index: 9999;
    background: linear-gradient(90deg,#0047ff 0%,#00b894 100%);
    color:#fff; padding:.6rem .9rem; border-bottom:3px solid rgba(0,0,0,.12);
    font-weight:700; letter-spacing:.2px; text-shadow:0 1px 0 rgba(0,0,0,.2);
  }
  #autoLoadBanner small{font-weight:400;opacity:.95}

  /* Main area (left) */
  main{
    padding: 16px;
  }
  .card{
    background: var(--panel-bg);
    border: 1px solid var(--panel-border);
    border-radius: 14px;
    padding: 12px 14px;
  }
  .muted{ color:var(--muted) }

  /* Right dock (control panel) */
  aside.control-dock{
    width: clamp(460px, 46vw, 780px) !important;
    max-height: 100vh; overflow: auto; padding: 16px 16px 24px;
    background: transparent;
  }
  aside.control-dock .panel{
    background: var(--panel-bg);
    border:1px solid var(--panel-border);
    border-radius:14px;
    padding: 0.8rem 0.9rem;
    margin-bottom: 0.7rem;
  }
  aside.control-dock .panel h2{ font-size:18px; margin:.2rem 0 .6rem }
  aside.control-dock .panel h3{ font-size:16px; margin:.6rem 0 .4rem }
  aside.control-dock label{ display:grid; gap:.3rem; font-size:13px }
  aside.control-dock input, aside.control-dock select, aside.control-dock textarea, aside.control-dock button{
    font-size:13px;
    padding: .44rem .5rem;
    border:1px solid #ccc; border-radius:10px;
  }
  aside.control-dock textarea{ min-height: 56px }
  .btn-primary{ background: var(--accent); color:white; border:none; cursor:pointer }
  .btn-secondary{ background:#e9eefc; color:#102a88; border:1px solid #bcd; cursor:pointer }
  .btn-ghost{ background: transparent; border:1px dashed #bbb; cursor:pointer }
  .button-row{ display:grid; gap:.5rem }

  /* Data Status */
  .status-chip{ padding:.6rem;border:1px solid var(--panel-border);border-radius:10px; }
  .ok   { background: rgba(0,160,0,.08) }
  .fail { background: rgba(200,0,0,.08) }

  /* Issues area */
  #issuesContainer{ display:grid; gap:.6rem; max-height: 68vh; overflow:auto }
  .issue-row{
    border:1px solid var(--panel-border); border-radius:12px; padding:.6rem; display:grid; gap:.5rem;
    background: #fff;
  }
  .grid-3{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:.5rem }
  .grid-2{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:.5rem }
  @media (max-width: 1200px){ .grid-3{ grid-template-columns: 1fr 1fr } }
  @media (max-width: 900px){ .grid-3, .grid-2{ grid-template-columns: 1fr } }

  /* Schedule table */
  table{ width:100%; border-collapse: collapse; }
  th, td{ border:1px solid #e3e3e3; padding:8px 10px; font-size:14px }
  th{ background:#fafafa; text-align:left }
  .pill{ display:inline-block; padding:.15rem .5rem; border-radius:999px; background:#eef; color:#223 }
</style>
</head>
<body>

<div id="autoLoadBanner">AUTO-LOAD MODE <small>(V3.9)</small></div>

<main>
  <div class="card">
    <h2>Exam Schedule</h2>
    <div class="muted" style="margin:.25rem 0 .75rem">This schedule auto-loads from <strong>timetable_exam.xlsx</strong> (same folder).</div>
    <div id="scheduleMeta" class="muted" style="margin-bottom:.5rem"></div>
    <div id="scheduleTableWrap">
      <table id="scheduleTable" aria-label="Exam Timetable">
        <thead><tr><th>Date</th><th>Time</th><th>Subject</th><th>Venue / Class</th><th>Notes</th></tr></thead>
        <tbody id="scheduleBody"><tr><td colspan="5" class="muted">Waiting for timetable…</td></tr></tbody>
      </table>
    </div>
  </div>
</main>

<aside class="control-dock">
  <section class="panel" id="dataStatusPanel">
    <h2>Data Status</h2>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem;">
      <div id="rosterStatus" class="status-chip">Roster: <span>Loading…</span></div>
      <div id="timetableStatus" class="status-chip">Timetable: <span>Waiting…</span></div>
    </div>
  </section>

  <section class="panel">
    <h2>Invigilation Records 記錄</h2>
    <label>Chief Invigilator / 主監考 (required)
      <input type="text" id="chiefInvigilatorInput" placeholder="Full name" required>
    </label>
    <label>Other Invigilators / 其他監考 (optional, comma-separated)
      <input type="text" id="otherInvigilatorsInput" placeholder="Name A, Name B">
    </label>

    <div class="schedule-group">
      <h3>Student Issues / 學生情況</h3>
      <div class="button-row" style="grid-template-columns:repeat(3, minmax(0,1fr))">
        <button type="button" class="btn-secondary" data-add="absent">Add Absentee</button>
        <button type="button" class="btn-secondary" data-add="late">Add Late Comer</button>
        <button type="button" class="btn-secondary" data-add="idcheck">Add Student ID</button>
      </div>
      <div class="button-row" style="grid-template-columns:repeat(2, minmax(0,1fr)); margin-top:.5rem;">
        <button type="button" class="btn-secondary" data-add="washroom">Add Washroom</button>
        <button type="button" class="btn-secondary" data-add="uniform">Add Improper Uniform</button>
      </div>

      <div id="issuesContainer" style="margin-top:.8rem"></div>
    </div>

    <div class="schedule-group">
      <h3>Irregularity (optional) / 非正規情況（可選）</h3>
      <textarea id="irregularityInput" placeholder="Describe any irregularities if any..."></textarea>
    </div>

    <div class="button-row" style="grid-template-columns:1fr">
      <button type="button" class="btn-primary" id="btnGeneratePdf">Generate PDF Report</button>
    </div>
  </section>
</aside>

<script>
(function(){
  const log = (...a)=>{ try{ console.log("[INVIGILATION]", ...a);}catch(e){} };
  const wait = (ms)=>new Promise(r=>setTimeout(r,ms));
  function $(sel,root=document){ return root.querySelector(sel); }
  function $all(sel,root=document){ return Array.from(root.querySelectorAll(sel)); }

  // Data status setters
  function setRosterStatus(text, ok){
    const el = $("#rosterStatus"); el.classList.toggle("ok",ok); el.classList.toggle("fail",!ok);
    el.querySelector("span").textContent = text;
  }
  function setTimetableStatus(text, ok){
    const el = $("#timetableStatus"); el.classList.toggle("ok",ok); el.classList.toggle("fail",!ok);
    el.querySelector("span").textContent = text;
  }

  // ===== ROSTER parsing (supports ClassCode OR Class + No) =====
  const rosterByClass = new Map();
  const rosterByClassNo = new Map();
  const rosterByClassCode = new Map();
  const NORM = {
    cls: s=>String(s||"").trim().toUpperCase().replace(/\s+/g,""),
    no:  s=>{ s=String(s||"").trim(); return /^\d+$/.test(s) ? s.padStart(2,"0") : s; }
  };
  function parseRosterWorkbook(wb){
    const sheetName = wb.SheetNames.find(n=>n.toLowerCase().includes("roster")) || wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(ws, { header:1, raw:true, blankrows:false });
    if(!rows.length) throw new Error("Roster sheet empty");

    const H = rows[0].map(h=>String(h||"").trim().toLowerCase());
    const idx = {
      classCode: H.findIndex(h=>/(classcode|class_code|cls_code)/.test(h)),
      class:     H.findIndex(h=>/^(\u73ed|class|cls)$/.test(h) || /^class\s*$/.test(h)),
      no:        H.findIndex(h=>/^(no|number|index|classno|class no|class_number|seat|roll)$/.test(h)),
      name:      H.findIndex(h=>/name/.test(h)),
      candidate: H.findIndex(h=>/(candidate|cand)/.test(h)),
    };
    if(idx.name===-1 || (idx.classCode===-1 && idx.class===-1)){
      throw new Error("Roster needs 'Name' AND either 'ClassCode' OR 'Class'.");
    }
    rosterByClass.clear(); rosterByClassNo.clear(); rosterByClassCode.clear();

    for(let r=1; r<rows.length; r++){
      const row = rows[r] || [];
      const rawClassCode = idx.classCode!==-1 ? row[idx.classCode] : "";
      const rawClass     = idx.class!==-1 ? row[idx.class] : "";
      const rawNo        = idx.no!==-1    ? row[idx.no]    : "";
      const rawName      = idx.name!==-1  ? row[idx.name]  : "";
      const rawCand      = idx.candidate!==-1 ? row[idx.candidate] : "";
      if(!rawName) continue;

      const cls = NORM.cls(rawClass);
      const no  = NORM.no(rawNo);
      const ccode = NORM.cls(rawClassCode);
      const student = { name:String(rawName).trim(), candidate:String(rawCand||"").trim(), class:cls||undefined, no:no||undefined };

      if(ccode){ (rosterByClassCode.get(ccode)||rosterByClassCode.set(ccode,[]).get(ccode)).push(student); }
      if(cls){ (rosterByClass.get(cls)||rosterByClass.set(cls,[]).get(cls)).push(student); }
      if(cls && no){ const key = `${cls}-${no}`; (rosterByClassNo.get(key)||rosterByClassNo.set(key,[]).get(key)).push(student); }
    }
  }
  function findCandidates(q){
    const cls = q.cls && NORM.cls(q.cls);
    const no  = q.no  && NORM.no(q.no);
    if (cls && no) return rosterByClassNo.get(`${cls}-${no}`) || [];
    if (cls)       return rosterByClass.get(cls) || [];
    if (q.classCode) return rosterByClassCode.get(NORM.cls(q.classCode)) || [];
    return [];
  }

  // ===== TIMETABLE parsing & rendering =====
  // parseExcelRows: normalize header variants → array of entries {date, time, subject, venue, notes}
  function parseExcelRows(rows){
    if(!rows || !rows.length) return [];
    const H = rows[0].map(h=>String(h||"").trim().toLowerCase());

    // Common header guessers
    const idx = {
      date:   H.findIndex(h=>/(date|exam\s*date|day)/.test(h)),
      time:   H.findIndex(h=>/(time|start.*end|session)/.test(h)),
      start:  H.findIndex(h=>/(start|from)\b/.test(h)),
      end:    H.findIndex(h=>/(end|to)\b/.test(h)),
      subject:H.findIndex(h=>/(subject|paper|exam)/.test(h)),
      venue:  H.findIndex(h=>/(venue|hall|room|class)/.test(h)),
      notes:  H.findIndex(h=>/(note|remark)/.test(h)),
    };

    const out = [];
    for(let r=1; r<rows.length; r++){
      const row = rows[r] || [];
      const date = idx.date!==-1 ? String(row[idx.date]||"").trim() : "";
      const time = idx.time!==-1 ? String(row[idx.time]||"").trim() :
                   (idx.start!==-1 || idx.end!==-1 ? `${row[idx.start]||""}–${row[idx.end]||""}`.trim() : "");
      const subject = idx.subject!==-1 ? String(row[idx.subject]||"").trim() : "";
      const venue   = idx.venue!==-1 ? String(row[idx.venue]||"").trim() : "";
      const notes   = idx.notes!==-1 ? String(row[idx.notes]||"").trim() : "";

      // skip empty rows
      if(!(date||time||subject||venue||notes)) continue;
      out.push({date,time,subject,venue,notes});
    }
    return out;
  }

  function setExamSchedule(entries, sourceLabel){
    const body = $("#scheduleBody");
    body.innerHTML = "";
    if(!entries || !entries.length){
      body.innerHTML = `<tr><td colspan="5" class="muted">No entries found.</td></tr>`;
      return;
    }
    entries.forEach(e=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${e.date||""}</td><td>${e.time||""}</td><td>${e.subject||""}</td><td>${e.venue||""}</td><td>${e.notes||""}</td>`;
      body.appendChild(tr);
    });
    $("#scheduleMeta").innerHTML = `<span class="pill">Loaded from: ${sourceLabel||"timetable_exam.xlsx"}</span>
      <span class="pill" style="margin-left:6px">${entries.length} entries</span>`;

    // Update "currently selected" details for PDF header (first row as current)
    const first = entries[0] || {};
    document.getElementById("subjectDisplay")?.remove();
    document.getElementById("venueDisplay")?.remove();
    document.getElementById("scheduledDateDisplay")?.remove();
    document.getElementById("scheduledTimeDisplay")?.remove();
    // Create hidden elements (for compatibility with prior versions)
    const hiddenWrap = document.createElement("div");
    hiddenWrap.style.display="none";
    hiddenWrap.innerHTML = `
      <div id="subjectDisplay">${first.subject||""}</div>
      <div id="venueDisplay">${first.venue||""}</div>
      <div id="scheduledDateDisplay">${first.date||""}</div>
      <div id="scheduledTimeDisplay">${first.time||""}</div>
    `;
    document.body.appendChild(hiddenWrap);
  }

  // ===== Fetch helpers =====
  async function fetchExcelExact(name){
    const url = "./" + name;
    log("Fetching", url);
    const res = await fetch(encodeURI(url), { cache: "no-store" });
    if(!res.ok) throw new Error(`HTTP ${res.status} for ${name}`);
    const buf = await res.arrayBuffer();
    return XLSX.read(new Uint8Array(buf), { type:"array", cellDates:true });
  }

  function tryBestSheet(workbook){
    let best = { sheet:"", parsed:[], count:-1 };
    for(const s of workbook.SheetNames){
      const ws = workbook.Sheets[s];
      const rows = XLSX.utils.sheet_to_json(ws, { header:1, raw:true, blankrows:false });
      const parsed = parseExcelRows(rows) || [];
      const c = parsed.length || 0;
      if(c > best.count) best = { sheet:s, parsed, count:c };
    }
    return best;
  }

  // ===== UI: issue entry builder =====
  const records = { absent: [], late: [], idcheck: [], washroom: [], uniform: [] };

  function makeIssueRow(kind){
    const row = document.createElement("div");
    row.className = "issue-row";
    row.innerHTML = `
      <div class="grid-3">
        <label>Class<input type="text" data-field="class" placeholder="e.g. 1B"></label>
        <label>Class No<input type="text" data-field="classNo" placeholder="e.g. 02"></label>
        <label>Candidate Name<select data-field="name"><option value="">—</option></select></label>
      </div>
      <label>Manual Name (if not in roster)<input type="text" data-field="nameManual" placeholder="Type name if needed"></label>
      <div data-extra></div>
      <div style="display:flex; gap:.5rem; justify-content:flex-end;">
        <button type="button" class="btn-ghost" data-action="remove">Remove</button>
        <button type="button" class="btn-secondary" data-action="save">Save</button>
      </div>
    `;
    const extra = row.querySelector("[data-extra]");
    if (kind === "late") {
      extra.innerHTML = `<label>Minutes Late<input type="number" min="0" data-field="minutesLate" placeholder="e.g. 5"></label>`;
    } else if (kind === "washroom") {
      extra.innerHTML = `
        <div class="grid-2">
          <label>Out Time<input type="time" data-field="outTime"></label>
          <label>In Time<input type="time" data-field="inTime"></label>
        </div>`;
    } else {
      extra.innerHTML = `<label>Note / 備註<textarea data-field="note" placeholder="Optional notes..."></textarea></label>`;
    }

    const nameSelect = row.querySelector('[data-field="name"]');
    function refreshNameOptions() {
      const cls = row.querySelector('[data-field="class"]').value.trim();
      const no  = row.querySelector('[data-field="classNo"]').value.trim();
      const list = findCandidates({ cls, no });
      nameSelect.innerHTML = `<option value="">—</option>` + list.map(s => {
        const label = s.candidate ? `${s.name} (${s.candidate})` : s.name;
        return `<option value="${s.name}">${label}</option>`;
      }).join("");
      if (no && list.length === 1) nameSelect.value = list[0].name;
    }
    row.querySelector('[data-field="class"]').addEventListener("input", refreshNameOptions);
    row.querySelector('[data-field="classNo"]').addEventListener("input", refreshNameOptions);

    row.querySelector('[data-action="remove"]').addEventListener("click", () => row.remove());
    row.querySelector('[data-action="save"]').addEventListener("click", () => {
      const cls = row.querySelector('[data-field="class"]').value.trim();
      const classNo = row.querySelector('[data-field="classNo"]').value.trim();
      const selectedName = nameSelect.value.trim();
      const manualName   = row.querySelector('[data-field="nameManual"]').value.trim();
      const finalName    = selectedName || manualName;
      if (!cls || !finalName) { alert("Please provide Class and a Candidate Name (from roster or manual)."); return; }
      const entry = { class: cls, classNo, name: finalName };
      if (kind === "late") {
        entry.minutesLate = parseInt(row.querySelector('[data-field="minutesLate"]').value, 10) || 0;
      } else if (kind === "washroom") {
        entry.outTime = row.querySelector('[data-field="outTime"]').value || "";
        entry.inTime  = row.querySelector('[data-field="inTime"]').value || "";
      } else {
        entry.note = row.querySelector('[data-field="note"]').value || "";
      }
      records[kind].push(entry);
      row.style.opacity = "0.6";
      row.querySelectorAll("input,select,textarea,button").forEach(el => el.disabled = true);
    });

    return row;
  }

  // Hook buttons
  $all('button[data-add]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const kind = btn.getAttribute('data-add');
      $("#issuesContainer").prepend(makeIssueRow(kind));
    });
  });

  // ===== PDF =====
  $("#btnGeneratePdf").addEventListener("click", () => {
    const irregularity = $("#irregularityInput").value.trim();
    const subject = document.getElementById("subjectDisplay")?.textContent.trim() || "";
    const venue   = document.getElementById("venueDisplay")?.textContent.trim() || "";
    const date    = document.getElementById("scheduledDateDisplay")?.textContent.trim() || "";
    const time    = document.getElementById("scheduledTimeDisplay")?.textContent.trim() || "";
    const chief   = $("#chiefInvigilatorInput").value.trim();
    const others  = $("#otherInvigilatorsInput").value.trim();
    if (!chief) { alert("Chief Invigilator is required."); return; }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt", format: "a4" });
    doc.setFontSize(14);
    doc.text("Methodist College — Exam Invigilation Report", 40, 40);
    doc.setFontSize(11);
    doc.text(`Subject: ${subject}`, 40, 60);
    doc.text(`Date: ${date}`, 40, 78);
    doc.text(`Time: ${time}`, 250, 78);
    doc.text(`Venue: ${venue}`, 40, 96);
    doc.text(`Chief Invigilator: ${chief}`, 40, 114);
    if (others) doc.text(`Other Invigilators: ${others}`, 40, 132);

    const counts = {
      Absentees: records.absent.length,
      "Late Comers": records.late.length,
      "Student ID Checks": records.idcheck.length,
      "Washroom": records.washroom.length,
      "Improper Uniform": records.uniform.length
    };
    let y = 158;
    doc.setFontSize(12);
    doc.text("Summary", 40, y);
    y += 6;
    doc.setFontSize(10);
    Object.entries(counts).forEach(([k,v]) => { y += 14; doc.text(`${k}: ${v}`, 50, y); });

    function tableFrom(kind, rows) {
      if (!rows.length) return null;
      const headersByKind = {
        absent: ["Class", "Class No", "Name", "Note"],
        late: ["Class", "Class No", "Name", "Minutes Late"],
        idcheck: ["Class", "Class No", "Name", "Note"],
        washroom: ["Class", "Class No", "Name", "Out Time", "In Time"],
        uniform: ["Class", "Class No", "Name", "Note"]
      };
      const cols = headersByKind[kind];
      const body = rows.map(r => {
        if (kind === "late") return [r.class || "", r.classNo || "", r.name, String(r.minutesLate || 0)];
        if (kind === "washroom") return [r.class || "", r.classNo || "", r.name, r.outTime || "", r.inTime || ""];
        return [r.class || "", r.classNo || "", r.name, r.note || ""];
      });
      return { columns: cols, body };
    }

    const kinds = ["absent","late","idcheck","washroom","uniform"];
    y += 26;
    kinds.forEach((k) => {
      const tbl = tableFrom(k, records[k]);
      if (!tbl) return;
      doc.setFontSize(12);
      doc.text(k.toUpperCase(), 40, y);
      y += 6;
      doc.autoTable({
        startY: y + 8,
        head: [tbl.columns],
        body: tbl.body,
        margin: { left: 40, right: 40 },
        styles: { fontSize: 9 }
      });
      y = doc.lastAutoTable.finalY + 16;
    });

    if (irregularity) {
      doc.setFontSize(12);
      doc.text("Irregularity (if any)", 40, y);
      y += 10;
      doc.setFontSize(10);
      const lines = doc.splitTextToSize(irregularity, 515);
      doc.text(lines, 40, y + 12);
    }

    doc.save("invigilation_report.pdf");
  });

  // ===== BOOT: auto-load roster.xlsx then timetable_exam.xlsx =====
  async function boot(){
    // 1) Roster (strict)
    try{
      const rWB = await fetchExcelExact("roster.xlsx");
      parseRosterWorkbook(rWB);
      const count =
        Array.from(rosterByClass.values()).reduce((a,arr)=>a+arr.length,0) ||
        Array.from(rosterByClassCode.values()).reduce((a,arr)=>a+arr.length,0);
      setRosterStatus(`Loaded (${count} students)`, true);
      log("Roster loaded:", count);
    }catch(e){
      setRosterStatus("Not found (expect: roster.xlsx)", false);
      log("Roster load failed", e);
    }

    // 2) Timetable (strict)
    try{
      const tWB = await fetchExcelExact("timetable_exam.xlsx");
      const best = tryBestSheet(tWB);
      if(best.count > 0){
        setExamSchedule(best.parsed, "timetable_exam.xlsx / " + best.sheet);
        setTimetableStatus(`Loaded (${best.count} entries)`, true);
        log("Timetable loaded:", best.count, "sheet:", best.sheet);
      }else{
        setTimetableStatus("Found file but could not parse rows", false);
        log("Timetable found but parseExcelRows returned 0 across sheets");
      }
    }catch(e){
      setTimetableStatus("Not found (expect: timetable_exam.xlsx)", false);
      log("Timetable load failed", e);
    }
  }

  if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", boot);
  else boot();
})();
</script>

</body>
</html>
