<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Methodist College – Invigilation Console (Complete Build)</title>

<!-- SheetJS (XLSX) + jsPDF + AutoTable -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.1/dist/jspdf.plugin.autotable.min.js"></script>

<style>
  :root{
    --panel-bg:#fff; --panel-border:#ddd; --ink:#111; --muted:#555; --accent:#3450ff;
    --bg:#f7f8fb; --ok:#3fb950; --bad:#ff7b72;
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; color:var(--ink); background:var(--bg);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    display:grid; grid-template-columns: 1fr auto; gap: 16px;
  }

  /* Top banner */
  #autoLoadBanner{
    position: sticky; top: 0; grid-column:1/-1; z-index: 10;
    background: linear-gradient(90deg,#3450ff 0%,#00b894 100%);
    color:#fff; padding:.6rem .9rem; border-bottom:3px solid rgba(0,0,0,.12);
    font-weight:700; letter-spacing:.2px; text-shadow:0 1px 0 rgba(0,0,0,.2);
  }
  #autoLoadBanner small{font-weight:400;opacity:.95}

  /* Left main area */
  main{ padding: 16px }
  .card{
    background: var(--panel-bg);
    border: 1px solid var(--panel-border);
    border-radius: 14px;
    padding: 12px 14px; margin-bottom: 14px;
  }
  .muted{ color: var(--muted) }

  /* Schedule table */
  table{ width:100%; border-collapse: collapse; }
  th, td{ border:1px solid #e6e6e6; padding:8px 10px; font-size:14px; vertical-align: top }
  th{ background:#fafafa; text-align:left }
  tr.sel{ outline: 2px solid var(--accent) }
  .pill{ display:inline-block; padding:.15rem .5rem; border-radius:999px; background:#eef; color:#223 }

  /* Timer panel */
  .timer-grid{ display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:12px }
  .timer-box{ background:#0c1116; color:#e2ebff; border-radius:14px; padding:14px; border:1px solid rgba(255,255,255,.08) }
  .timer-big{ font-size:42px; letter-spacing:1px; font-weight:700 }
  .timer-small{ font-size:13px; opacity:.85 }
  .progress{ height:8px; border-radius:8px; background:#1b2430; overflow:hidden; border:1px solid rgba(255,255,255,.08) }
  .progress > div{ height:100%; background:#2ecc71; width:0% }
  .btn-row{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px }
  .btn{ padding:.5rem .75rem; border-radius:10px; border:1px solid #bcd; background:#eef4ff; color:#102a88; cursor:pointer }
  .btn.ghost{ background:transparent; border-style:dashed }
  .btn.primary{ background:var(--accent); color:#fff; border:none }

  /* Right dock */
  aside.control-dock{
    width: clamp(440px, 42vw, 780px) !important;
    max-height: 100vh; overflow: auto; padding: 16px 16px 24px;
  }
  aside.control-dock .panel{
    background: var(--panel-bg);
    border:1px solid var(--panel-border);
    border-radius:14px;
    padding: 0.9rem 1rem;
    margin-bottom: 0.9rem;
  }
  aside.control-dock .panel h2{ font-size:18px; margin:.2rem 0 .6rem }
  aside.control-dock .panel h3{ font-size:16px; margin:.6rem 0 .4rem }
  aside.control-dock label{ display:grid; gap:.3rem; font-size:13px }
  aside.control-dock input, aside.control-dock select, aside.control-dock textarea, aside.control-dock button{
    font-size:13px;
    padding: .44rem .5rem;
    border:1px solid #ccc; border-radius:10px;
  }
  aside.control-dock textarea{ min-height: 56px }
  .btn-primary{ background: var(--accent); color:white; border:none; cursor:pointer }
  .btn-secondary{ background:#e9eefc; color:#102a88; border:1px solid #bcd; cursor:pointer }
  .btn-ghost{ background: transparent; border:1px dashed #bbb; cursor:pointer }
  .button-row{ display:grid; gap:.5rem }

  /* Status chips */
  .status-chip{ padding:.6rem;border:1px solid var(--panel-border);border-radius:10px; }
  .ok   { background: rgba(63,185,80,.12) }
  .fail { background: rgba(255,123,114,.12) }

  /* Issues */
  #issuesContainer{ display:grid; gap:.6rem; max-height: 50vh; overflow:auto }
  .issue-row{
    border:1px solid var(--panel-border); border-radius:12px; padding:.6rem; display:grid; gap:.5rem;
    background: #fff;
  }
  .grid-3{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:.5rem }
  .grid-2{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:.5rem }
  @media (max-width: 1200px){ .grid-3{ grid-template-columns: 1fr 1fr } }
  @media (max-width: 900px){ .grid-3, .grid-2{ grid-template-columns: 1fr } }

  /* Live Summary */
  .kpi-row{ display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:.4rem; margin:.4rem 0 .6rem }
  .kpi{ background:#f6f8ff; border:1px solid #dfe6ff; border-radius:10px; padding:.5rem; text-align:center }
  .kpi strong{ display:block; font-size: 18px }
  .tag{ display:inline-block; padding:.15rem .45rem; border-radius:999px; font-size: 12px; border:1px solid #ccc; margin-right:.25rem }
  .tag.absent{ background:#fff1f1; border-color:#ffc6c6 }
  .tag.late{ background:#fff7e6; border-color:#ffdf9e }
  .tag.idcheck{ background:#eefcff; border-color:#bfefff }
  .tag.washroom{ background:#f1fff1; border-color:#c8f7c8 }
  .tag.uniform{ background:#f8f1ff; border-color:#e2ccff }
  .list{ max-height: 24vh; overflow:auto; border:1px solid var(--panel-border); border-radius:10px; padding:.5rem }
  .list-item{ display:flex; gap:.5rem; align-items:center; padding:.35rem 0; border-bottom:1px dashed #eee }
  .list-item:last-child{ border-bottom:none }
  .muted{ color: var(--muted) }
</style>
</head>
<body>

<div id="autoLoadBanner">AUTO-LOAD MODE <small>(Complete Build)</small></div>

<main>
  <div class="card">
    <h2>Exam Timer & Current Session</h2>
    <div class="timer-grid">
      <div class="timer-box">
        <div class="timer-small">Current Time</div>
        <div id="nowClock" class="timer-big">--:--:--</div>
        <div class="timer-small" id="todayDate"></div>
      </div>
      <div class="timer-box">
        <div class="timer-small">Selected Exam</div>
        <div id="selSubject" class="timer-big" style="font-size:28px">No exam selected</div>
        <div class="timer-small" id="selMeta">Select a row from the timetable below.</div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;background:#0c1116;color:#e2ebff;border-color:rgba(255,255,255,.12)">
      <div class="timer-small">Countdown</div>
      <div id="countdown" class="timer-big">--:--:--</div>
      <div class="progress"><div id="progressBar"></div></div>
      <div class="btn-row">
        <button class="btn primary" id="btnStartNow">Start Now</button>
        <button class="btn" id="btnStartAt">Start at Scheduled</button>
        <button class="btn" id="btnPause">Pause</button>
        <button class="btn ghost" id="btnReset">Reset</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Exam Timetable</h2>
    <div class="muted" style="margin:.25rem 0 .75rem">Auto-loads from <strong>timetable_exam.xlsx</strong> (same folder).</div>
    <div id="scheduleMeta" class="muted" style="margin-bottom:.5rem"></div>
    <div id="scheduleTableWrap">
      <table id="scheduleTable" aria-label="Exam Timetable">
        <thead><tr><th>Date</th><th>Start</th><th>End</th><th>Duration</th><th>Subject</th><th>Venue</th></tr></thead>
        <tbody id="scheduleBody"><tr><td colspan="6" class="muted">Waiting for timetable…</td></tr></tbody>
      </table>
    </div>
  </div>
</main>

<aside class="control-dock">
  <section class="panel" id="dataStatusPanel">
    <h2>Data Status</h2>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem;">
      <div id="rosterStatus" class="status-chip">Roster: <span>Loading…</span></div>
      <div id="timetableStatus" class="status-chip">Timetable: <span>Waiting…</span></div>
    </div>
  </section>

  <section class="panel" id="liveSummaryPanel">
    <h2>Live Issues Summary</h2>
    <div class="kpi-row">
      <div class="kpi"><strong id="k_absent">0</strong><div class="muted">Absentees</div></div>
      <div class="kpi"><strong id="k_late">0</strong><div class="muted">Late</div></div>
      <div class="kpi"><strong id="k_idcheck">0</strong><div class="muted">ID Checks</div></div>
      <div class="kpi"><strong id="k_washroom">0</strong><div class="muted">Washroom</div></div>
      <div class="kpi"><strong id="k_uniform">0</strong><div class="muted">Uniform</div></div>
    </div>
    <div class="list" id="liveList"></div>
  </section>

  <section class="panel">
    <h2>Invigilation Records 記錄</h2>
    <label>Chief Invigilator / 主監考 (required)
      <input type="text" id="chiefInvigilatorInput" placeholder="Full name" required>
    </label>
    <label>Other Invigilators / 其他監考 (optional, comma-separated)
      <input type="text" id="otherInvigilatorsInput" placeholder="Name A, Name B">
    </label>

    <div class="schedule-group">
      <h3>Student Issues / 學生情況</h3>
      <div class="button-row" style="grid-template-columns:repeat(3, minmax(0,1fr))">
        <button type="button" class="btn-secondary" data-add="absent">Add Absentee</button>
        <button type="button" class="btn-secondary" data-add="late">Add Late Comer</button>
        <button type="button" class="btn-secondary" data-add="idcheck">Add Student ID</button>
      </div>
      <div class="button-row" style="grid-template-columns:repeat(2, minmax(0,1fr));margin-top:.5rem;">
        <button type="button" class="btn-secondary" data-add="washroom">Add Washroom</button>
        <button type="button" class="btn-secondary" data-add="uniform">Add Improper Uniform</button>
      </div>

      <div id="issuesContainer" style="margin-top:.8rem"></div>
    </div>

    <div class="schedule-group">
      <h3>Irregularity (optional) / 非正規情況（可選）</h3>
      <textarea id="irregularityInput" placeholder="Describe any irregularities if any..."></textarea>
    </div>

    <div class="button-row" style="grid-template-columns:1fr;gap:.6rem;">
      <button type="button" class="btn-primary" id="btnGeneratePdf">Generate PDF Report</button>
    </div>
  </section>
</aside>

<script>
(function(){
  const log = (...a)=>{ try{ console.log("[INVIGILATION]", ...a);}catch(e){} };
  const wait = (ms)=>new Promise(r=>setTimeout(r,ms));
  const pad2 = n => String(n).padStart(2,"0");
  function $(sel,root=document){ return root.querySelector(sel); }
  function $all(sel,root=document){ return Array.from(root.querySelectorAll(sel)); }

  // ===== Clock =====
  function updateClock(){
    const now = new Date();
    $("#nowClock").textContent = `${pad2(now.getHours())}:${pad2(now.getMinutes())}:${pad2(now.getSeconds())}`;
    $("#todayDate").textContent = now.toDateString();
  }
  setInterval(updateClock, 500); updateClock();

  // ===== Status chips =====
  function setRosterStatus(text, ok){
    const el = $("#rosterStatus"); el.classList.toggle("ok",ok); el.classList.toggle("fail",!ok);
    el.querySelector("span").textContent = text;
  }
  function setTimetableStatus(text, ok){
    const el = $("#timetableStatus"); el.classList.toggle("ok",ok); el.classList.toggle("fail",!ok);
    el.querySelector("span").textContent = text;
  }

  // ===== Roster model & parsing (Class + Class No) =====
  const rosterByClass = new Map();
  const rosterByClassNo = new Map();
  const NORM = {
    cls: s=>String(s||"").trim().toUpperCase().replace(/\\s+/g,""),
    no:  s=>{ s=String(s||"").trim(); return /^\\d+$/.test(s) ? s.padStart(2,"0") : s; }
  };
  function parseRosterWorkbook(wb){
    const sheetName = wb.SheetNames.find(n=>n.toLowerCase().includes("roster")) || wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(ws, { header:1, raw:true, blankrows:false });
    if(!rows.length) throw new Error("Roster sheet empty");

    const H = rows[0].map(h=>String(h||"").trim().toLowerCase());
    const idx = {
      class:     H.findIndex(h=>/^(class|cls|\\u73ed)$/.test(h) || /^class\\s*$/.test(h)),
      no:        H.findIndex(h=>/^(no|number|index|classno|class no|class_number|seat|roll)$/.test(h)),
      name:      H.findIndex(h=>/name/.test(h)),
      candidate: H.findIndex(h=>/(candidate|cand)/.test(h)),
    };
    if(idx.name===-1 || idx.class===-1){
      throw new Error("Roster needs 'Name' and 'Class' (and optionally 'No').");
    }
    rosterByClass.clear(); rosterByClassNo.clear();

    for(let r=1;r<rows.length;r++){
      const row=rows[r]||[];
      const rawClass = idx.class!==-1 ? row[idx.class] : "";
      const rawNo    = idx.no!==-1    ? row[idx.no]    : "";
      const rawName  = idx.name!==-1  ? row[idx.name]  : "";
      const rawCand  = idx.candidate!==-1 ? row[idx.candidate] : "";
      if(!rawName) continue;

      const cls = NORM.cls(rawClass);
      const no  = NORM.no(rawNo);
      const student = { name:String(rawName).trim(), candidate:String(rawCand||"").trim(), class:cls||undefined, no:no||undefined };

      if(cls){ (rosterByClass.get(cls)||rosterByClass.set(cls,[]).get(cls)).push(student); }
      if(cls && no){ const key=`${cls}-${no}`; (rosterByClassNo.get(key)||rosterByClassNo.set(key,[]).get(key)).push(student); }
    }
  }
  function findCandidates(q){
    const cls = q.cls && NORM.cls(q.cls);
    const no  = q.no  && NORM.no(q.no);
    if(cls && no) return rosterByClassNo.get(`${cls}-${no}`) || [];
    if(cls)       return rosterByClass.get(cls) || [];
    return [];
  }

  // ===== Timetable parsing (accepts: first column date, then time/subject/venue triplets) =====
  function normalizeTime(str){
    if(!str) return "";
    const m = String(str).trim().match(/^(\\d{1,2})(?::(\\d{2}))?$/);
    if(!m) return "";
    const h = Number(m[1]), mm = Number(m[2]||"0");
    if (h<0||h>23||mm<0||mm>59) return "";
    return `${pad2(h)}:${pad2(mm)}`;
  }
  function parseRange(raw){
    if(!raw) return {startTime:"",endTime:""};
    const sanitized = String(raw).trim().replace(/[–—]/g,"-").replace(/\\s*to\\s*/i,"-");
    const parts = sanitized.split("-").map(normalizeTime);
    if(parts[0]&&parts[1]) return {startTime:parts[0], endTime:parts[1]};
    if(parts[0]) return {startTime:parts[0], endTime:""};
    return {startTime:"", endTime:""};
  }
  function durMin(a,b){ if(!a||!b) return 0; const [ah,am]=a.split(":").map(Number), [bh,bm]=b.split(":").map(Number); let A=ah*60+am, B=bh*60+bm; if(B<A) B+=1440; return B-A; }
  function parseExcelDate(value){
    if(value == null || value==="") return "";
    if(value instanceof Date && !Number.isNaN(value.getTime())) return `${value.getFullYear()}-${pad2(value.getMonth()+1)}-${pad2(value.getDate())}`;
    if(typeof value==="number" && Number.isFinite(value)){ const p=XLSX.SSF.parse_date_code(value); if(p) return `${p.y}-${pad2(p.m)}-${pad2(p.d)}`; }
    if(typeof value==="string"){
      const t=value.trim();
      if(/^\\d{4}-\\d{1,2}-\\d{1,2}$/.test(t)){ const [y,m,d]=t.split("-").map(Number); return `${y}-${pad2(m)}-${pad2(d)}`;}
      if(/^\\d{1,2}[\\/\\-]\\d{1,2}[\\/\\-]\\d{2,4}$/.test(t)){ const [dVal,mVal,yRaw]=t.split(/[\\/\\-]/); const y= yRaw.length===2? Number(\`20\${yRaw}\`):Number(yRaw); return `${y}-${pad2(+mVal)}-${pad2(+dVal)}`;}
      const dt=new Date(t); if(!Number.isNaN(dt.getTime())) return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}`;
    }
    return "";
  }

  function parseTimetableRows(rows){
    if(!rows || !rows.length) return [];
    const dataRows = rows.slice(1);
    let out=[]; let lastDate="";
    dataRows.forEach((row,rowIndex)=>{
      if(!row||!row.length) return;
      const maybeDate = parseExcelDate(row[0]);
      if(maybeDate) lastDate = maybeDate;

      for(let off=1; off<row.length; off+=3){
        const timeCell = row[off];
        const subjectCell = row[off+1];
        const venueCell = row[off+2];
        const subject = subjectCell ? String(subjectCell).trim() : "";
        const venue   = venueCell ? String(venueCell).trim()   : "";
        if(!subject && !timeCell && !venue) continue;

        let startTime="", endTime="";
        if(timeCell){
          const s = String(timeCell).trim();
          if(s.includes("-")) { const r = parseRange(s); startTime=r.startTime; endTime=r.endTime; }
          else { startTime = normalizeTime(s); }
        }
        out.push({
          id: `ex-${rowIndex}-${off}`,
          subject,
          date: maybeDate || lastDate || "",
          startTime, endTime,
          durationMinutes: (startTime&&endTime)? durMin(startTime,endTime):0,
          venue: venue || "—"
        });
      }
    });
    return out.filter(e => e.subject || e.startTime || e.endTime || e.venue);
  }

  function renderSchedule(entries){
    const body = $("#scheduleBody");
    body.innerHTML = "";
    if(!entries.length){ body.innerHTML = `<tr><td colspan="6" class="muted">No entries found.</td></tr>`; return; }
    entries.forEach(e=>{
      const tr = document.createElement("tr");
      tr.dataset.id = e.id;
      tr.innerHTML = `
        <td>${e.date||""}</td>
        <td>${e.startTime||""}</td>
        <td>${e.endTime||""}</td>
        <td>${e.durationMinutes? e.durationMinutes+" min" : ""}</td>
        <td>${e.subject||""}</td>
        <td>${e.venue||""}</td>`;
      tr.addEventListener("click", ()=>selectExam(e,tr));
      body.appendChild(tr);
    });
  }

  // ===== Selection + Timer =====
  let currentExam = null;
  let timer = { running:false, startTs:0, endTs:0, raf:0, pausedAt:0 };

  function selectExam(e, tr){
    $all("#scheduleBody tr").forEach(r=>r.classList.remove("sel"));
    tr && tr.classList.add("sel");
    currentExam = e;
    $("#selSubject").textContent = e.subject || "Untitled";
    $("#selMeta").textContent = `${e.date||"??"}  ${e.startTime||"--:--"} – ${e.endTime||"--:--"}   @ ${e.venue||"—"}`;
    // Prepare default start/end
    if(e.date && e.startTime){
      const [Y,M,D] = e.date.split("-").map(Number);
      const [h,m]   = (e.startTime||"00:00").split(":").map(Number);
      const start = new Date(Y, M-1, D, h, m, 0);
      let end = null;
      if(e.endTime){
        const [h2,m2] = e.endTime.split(":").map(Number);
        end = new Date(Y, M-1, D, h2, m2, 0);
        if(end < start) end = new Date(end.getTime() + 24*60*60*1000);
      }else if(e.durationMinutes){
        end = new Date(start.getTime() + e.durationMinutes*60*1000);
      }
      timer.startTs = +start;
      timer.endTs   = end ? +end : 0;
      refreshCountdown();
    }
  }

  function fmtDur(ms){
    if(ms < 0) ms = 0;
    const s = Math.floor(ms/1000);
    const hh = Math.floor(s/3600);
    const mm = Math.floor((s%3600)/60);
    const ss = s%60;
    return `${pad2(hh)}:${pad2(mm)}:${pad2(ss)}`;
  }
  function refreshCountdown(){
    const now = Date.now();
    let rem = 0, total = 0;
    if(timer.running && timer.endTs){
      rem = timer.endTs - now;
      total = timer.endTs - timer.startTs;
    }else if(!timer.running && timer.endTs){
      rem = timer.endTs - (timer.pausedAt || now);
      total = timer.endTs - timer.startTs;
    }else{
      $("#countdown").textContent = "--:--:--";
      $("#progressBar").style.width = "0%";
      return;
    }
    $("#countdown").textContent = fmtDur(rem);
    const pct = Math.max(0, Math.min(100, 100 * (total - rem) / (total||1)));
    $("#progressBar").style.width = `${pct}%`;
  }
  function tick(){
    if(!timer.running){ cancelAnimationFrame(timer.raf); return; }
    refreshCountdown();
    timer.raf = requestAnimationFrame(tick);
  }

  $("#btnStartNow").addEventListener("click", ()=>{
    if(!currentExam){ alert("Select an exam row first."); return; }
    const now = Date.now();
    const duration = timer.endTs ? (timer.endTs - timer.startTs) : (currentExam.durationMinutes||0)*60*1000;
    timer.startTs = now;
    timer.endTs = now + (duration||0);
    timer.running = true; timer.pausedAt = 0;
    tick();
  });
  $("#btnStartAt").addEventListener("click", ()=>{
    if(!currentExam){ alert("Select an exam row first."); return; }
    if(!timer.startTs || !timer.endTs){ alert("Start / End time missing for this row."); return; }
    timer.running = true; timer.pausedAt = 0;
    tick();
  });
  $("#btnPause").addEventListener("click", ()=>{
    if(!timer.running) return;
    timer.running = false;
    timer.pausedAt = Date.now();
    refreshCountdown();
  });
  $("#btnReset").addEventListener("click", ()=>{
    timer = { running:false, startTs:0, endTs:0, raf:0, pausedAt:0 };
    $("#countdown").textContent = "--:--:--";
    $("#progressBar").style.width = "0%";
  });

  // ===== Fetch helpers & auto-load =====
  async function fetchExcelExact(name){
    const url = "./" + name;
    const res = await fetch(encodeURI(url), { cache: "no-store" });
    if(!res.ok) throw new Error(`HTTP ${res.status} for ${name}`);
    const buf = await res.arrayBuffer();
    return XLSX.read(new Uint8Array(buf), { type:"array", cellDates:true });
  }
  function bestSheetBy(entriesPerSheet){
    let best = {sheet:"", entries:[], count:-1};
    for(const [sheet, entries] of entriesPerSheet){
      if(entries.length > best.count) best = {sheet, entries, count: entries.length};
    }
    return best;
  }

  async function autoLoad(){
    // Roster
    try{
      const rWB = await fetchExcelExact("roster.xlsx");
      parseRosterWorkbook(rWB);
      const count = Array.from(rosterByClass.values()).reduce((a,arr)=>a+arr.length,0);
      setRosterStatus(`Loaded (${count} students)`, true);
    }catch(e){
      setRosterStatus("Not found (expect: roster.xlsx)", false);
      console.warn("Roster auto-load failed:", e);
    }

    // Timetable
    try{
      const tWB = await fetchExcelExact("timetable_exam.xlsx");
      const entriesPerSheet = new Map();
      for(const s of tWB.SheetNames){
        const rows = XLSX.utils.sheet_to_json(tWB.Sheets[s], { header:1, raw:true, blankrows:false });
        const parsed = parseTimetableRows(rows);
        entriesPerSheet.set(s, parsed);
      }
      const best = bestSheetBy(entriesPerSheet);
      if(best.count > 0){
        renderSchedule(best.entries);
        setTimetableStatus(`Loaded (${best.count} entries)`, true);
        $("#scheduleMeta").innerHTML = `<span class="pill">Loaded: timetable_exam.xlsx / ${best.sheet}</span>
          <span class="pill" style="margin-left:6px">${best.count} entries</span>`;
        // Pre-select today's first exam (if any)
        const today = new Date(); const y = today.getFullYear(), m = pad2(today.getMonth()+1), d = pad2(today.getDate());
        const todayStr = `${y}-${m}-${d}`;
        const idx = best.entries.findIndex(e => e.date === todayStr);
        if(idx >= 0){
          const tr = $(`#scheduleBody tr:nth-child(${idx+1})`);
          tr && tr.click();
        }
      }else{
        setTimetableStatus("Found file but could not parse rows", false);
      }
    }catch(e){
      setTimetableStatus("Not found (expect: timetable_exam.xlsx)", false);
      console.warn("Timetable auto-load failed:", e);
    }
  }

  // ===== Invigilation module =====
  const records = { absent: [], late: [], idcheck: [], washroom: [], uniform: [] };
  function updateKPIs(){
    ["absent","late","idcheck","washroom","uniform"].forEach(k=>{ const el=$("#k_"+k); if(el) el.textContent = String(records[k].length); });
  }
  function addLiveItem(kind, entry){
    const list=$("#liveList");
    const div=document.createElement("div");
    div.className="list-item";
    const extra = kind==="late" ? ` • ${entry.minutesLate||0} min`
               : kind==="washroom" ? ` • ${entry.outTime||""} → ${entry.inTime||""}`
               : entry.note ? ` • ${entry.note}` : "";
    div.innerHTML = `<span class="tag ${kind}">${kind.toUpperCase()}</span>
    <span><strong>${entry.class||""} ${entry.classNo||""} — ${entry.name}</strong><span class="muted">${extra}</span></span>`;
    list.prepend(div);
    updateKPIs();
  }
  function makeIssueRow(kind){
    const row=document.createElement("div");
    row.className="issue-row";
    row.innerHTML = `
      <div class="grid-3">
        <label>Class<input type="text" data-field="class" placeholder="e.g. 1B"></label>
        <label>Class No<input type="text" data-field="classNo" placeholder="e.g. 02"></label>
        <label>Candidate Name<select data-field="name"><option value="">—</option></select></label>
      </div>
      <label>Manual Name (if not in roster)<input type="text" data-field="nameManual" placeholder="Type name if needed"></label>
      <div data-extra></div>
      <div style="display:flex; gap:.5rem; justify-content:flex-end;">
        <button type="button" class="btn-ghost" data-action="remove">Remove</button>
        <button type="button" class="btn-secondary" data-action="save">Save</button>
      </div>`;

    const extra=row.querySelector("[data-extra]");
    if(kind==="late"){
      extra.innerHTML = `<label>Minutes Late<input type="number" min="0" data-field="minutesLate" placeholder="e.g. 5"></label>`;
    }else if(kind==="washroom"){
      extra.innerHTML = `<div class="grid-2"><label>Out Time<input type="time" data-field="outTime"></label>
                         <label>In Time<input type="time" data-field="inTime"></label></div>`;
    }else{
      extra.innerHTML = `<label>Note / 備註<textarea data-field="note" placeholder="Optional notes..."></textarea>`;
    }

    const nameSelect=row.querySelector('[data-field="name"]');
    function refreshNameOptions(){
      const cls = row.querySelector('[data-field="class"]').value.trim();
      const no  = row.querySelector('[data-field="classNo"]').value.trim();
      const list = findCandidates({ cls, no });
      nameSelect.innerHTML = `<option value="">—</option>` + list.map(s => {
        const label = s.candidate ? \`\${s.name} (\${s.candidate})\` : s.name;
        return \`<option value="\${s.name}">\${label}</option>\`;
      }).join("");
      if (no && list.length === 1) nameSelect.value = list[0].name;
    }
    row.querySelector('[data-field="class"]').addEventListener("input", refreshNameOptions);
    row.querySelector('[data-field="classNo"]').addEventListener("input", refreshNameOptions);

    row.querySelector('[data-action="remove"]').addEventListener("click", ()=>row.remove());
    row.querySelector('[data-action="save"]').addEventListener("click", ()=>{
      const cls = row.querySelector('[data-field="class"]').value.trim();
      const classNo = row.querySelector('[data-field="classNo"]').value.trim();
      const selectedName = nameSelect.value.trim();
      const manualName   = row.querySelector('[data-field="nameManual"]').value.trim();
      const finalName    = selectedName || manualName;
      if (!cls || !finalName) { alert("Please provide Class and a Candidate Name (from roster or manual)."); return; }
      const entry = { class: cls, classNo, name: finalName };
      if (kind === "late") {
        entry.minutesLate = parseInt(row.querySelector('[data-field="minutesLate"]').value, 10) || 0;
      } else if (kind === "washroom") {
        entry.outTime = row.querySelector('[data-field="outTime"]').value || "";
        entry.inTime  = row.querySelector('[data-field="inTime"]').value || "";
      } else {
        entry.note = row.querySelector('[data-field="note"]').value || "";
      }
      records[kind].push(entry);
      addLiveItem(kind, entry);
      row.style.opacity = "0.6";
      row.querySelectorAll("input,select,textarea,button").forEach(el => el.disabled = true);
    });

    return row;
  }

  $all('button[data-add]').forEach(btn => {
    btn.addEventListener('click', ()=>{
      $("#issuesContainer").prepend( makeIssueRow(btn.getAttribute('data-add')) );
    });
  });

  // ===== PDF =====
  $("#btnGeneratePdf").addEventListener("click", () => {
    const irregularity = $("#irregularityInput").value.trim();
    const subj = $("#selSubject").textContent.trim() || "";
    const meta = $("#selMeta").textContent.trim() || "";
    const chief = $("#chiefInvigilatorInput").value.trim();
    const others = $("#otherInvigilatorsInput").value.trim();
    if (!chief) { alert("Chief Invigilator is required."); return; }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "pt", format: "a4" });

    doc.setFontSize(14);
    doc.text("Methodist College — Exam Invigilation Report", 40, 40);
    doc.setFontSize(11);
    doc.text(`Selected: ${subj}`, 40, 60);
    doc.text(meta, 40, 78);
    doc.text(`Chief Invigilator: ${chief}`, 40, 96);
    if (others) doc.text(`Other Invigilators: ${others}`, 40, 114);

    const counts = {
      Absentees: records.absent.length,
      "Late Comers": records.late.length,
      "Student ID Checks": records.idcheck.length,
      "Washroom": records.washroom.length,
      "Improper Uniform": records.uniform.length
    };
    let y = 138;
    doc.setFontSize(12);
    doc.text("Summary", 40, y);
    y += 6;
    doc.setFontSize(10);
    Object.entries(counts).forEach(([k,v]) => { y += 14; doc.text(`${k}: ${v}`, 50, y); });

    function tableFrom(kind, rows) {
      if (!rows.length) return null;
      const headersByKind = {
        absent: ["Class", "Class No", "Name", "Note"],
        late: ["Class", "Class No", "Name", "Minutes Late"],
        idcheck: ["Class", "Class No", "Name", "Note"],
        washroom: ["Class", "Class No", "Name", "Out Time", "In Time"],
        uniform: ["Class", "Class No", "Name", "Note"]
      };
      const cols = headersByKind[kind];
      const body = rows.map(r => {
        if (kind === "late") return [r.class || "", r.classNo || "", r.name, String(r.minutesLate || 0)];
        if (kind === "washroom") return [r.class || "", r.classNo || "", r.name, r.outTime || "", r.inTime || ""];
        return [r.class || "", r.classNo || "", r.name, r.note || ""];
      });
      return { columns: cols, body };
    }

    const kinds = ["absent","late","idcheck","washroom","uniform"];
    y += 26;
    kinds.forEach((k) => {
      const tbl = tableFrom(k, records[k]);
      if (!tbl) return;
      doc.setFontSize(12);
      doc.text(k.toUpperCase(), 40, y);
      y += 6;
      doc.autoTable({
        startY: y + 8,
        head: [tbl.columns],
        body: tbl.body,
        margin: { left: 40, right: 40 },
        styles: { fontSize: 9 }
      });
      y = doc.lastAutoTable.finalY + 16;
    });

    if (irregularity) {
      doc.setFontSize(12);
      doc.text("Irregularity (if any)", 40, y);
      y += 10;
      doc.setFontSize(10);
      const lines = doc.splitTextToSize(irregularity, 515);
      doc.text(lines, 40, y + 12);
    }

    doc.save("invigilation_report.pdf");
  });

  // ===== Boot =====
  if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", autoLoad);
  else autoLoad();
})();
</script>

</body>
</html>
